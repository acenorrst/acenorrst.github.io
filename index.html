<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TravelPerfect Agent | Premium Travel Planning Solutions</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Force cache invalidation with version parameter -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Add a timestamp to force browsers to recognize this as a new page -->
    <meta name="version" content="v2.1.<?php echo time(); ?>">
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-light: #818CF8;
            --primary-dark: #4338CA;
            --secondary-color: #D97706; /* Warm amber for travel theme */
            --accent-color: #92400E; /* Rich brown for rustic accents */
            --text-color: #1F2937;
            --text-light: #6B7280;
            --background-color: #FEF7ED; /* Warm cream background for travel feel */
            --white: #FFFFFF;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 16px;
            --vh: 1vh; /* Custom property for iOS height fix */
            --travel-texture: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+CiAgPGRlZnM+CiAgICA8cGF0dGVybiBpZD0idHJhdmVsIiBwYXR0ZXJuVW5pdHM9InVzZXJTcGFjZU9uVXNlIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCI+CiAgICAgIDxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSJyZ2JhKDIxNywxMTksNiwwLjA1KSIvPgogICAgICA8ZyBmaWxsPSJub25lIiBzdHJva2U9InJnYmEoMTQ2LDY0LDE0LDAuMDMpIiBzdHJva2Utd2lkdGg9IjEiPgogICAgICAgIDxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjMiLz4KICAgICAgICA8Y2lyY2xlIGN4PSIxNTAiIGN5PSI3NSIgcj0iMiIvPgogICAgICAgIDxjaXJjbGUgY3g9IjEwMCIgY3k9IjEyNSIgcj0iMi41Ii8+CiAgICAgICAgPGNpcmNsZSBjeD0iMjUiIGN5PSIxNzUiIHI9IjIiLz4KICAgICAgICA8Y2lyY2xlIGN4PSIxNzUiIGN5PSIyNSIgcj0iMS41Ii8+CiAgICAgICAgPHBhdGggZD0iTTMwIDMwIEwgNDAgNDAiLz4KICAgICAgICA8cGF0aCBkPSJNMTYwIDYwIEwgMTcwIDcwIi8+CiAgICAgICAgPHBhdGggZD0iTTgwIDEwMCBMIDkwIDExMCIvPgogICAgICA8L2c+CiAgICA8L3BhdHRlcm4+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjdHJhdmVsKSIvPgo8L3N2Zz4=');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-image: var(--travel-texture);
            background-repeat: repeat;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            /* Add subtle border */
            border: 1px solid rgba(217, 119, 6, 0.2);
            margin: 0 auto; /* Ensure horizontal centering */
        }

        .sidebar {
            width: 38%; /* Increased width for more prominence */
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            min-width: 300px; /* Ensure minimum width */
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(20deg);
            z-index: 0;
        }

        /* Add subtle travel texture overlay to sidebar */
        .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--travel-texture);
            opacity: 0.05;
            z-index: 0;
        }

        .sidebar-content {
            position: relative;
            z-index: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 2rem; /* Larger logo */
            font-weight: 700;
            margin-bottom: 2rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2); /* Add subtle text shadow */
            letter-spacing: 0.5px; /* Slight letter spacing for rustic feel */
        }

        .tagline {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 1.5rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.15); /* Add subtle text shadow */
        }

        .description {
            font-size: 1.1rem; /* Slightly larger for better readability */
            font-weight: 400;
            line-height: 1.6;
            margin-bottom: 2rem;
            letter-spacing: 0.2px; /* Slight letter spacing for rustic feel */
        }

        .features {
            margin-top: auto;
            background-color: rgba(0, 0, 0, 0.1); /* Semi-transparent background */
            padding: 1.2rem;
            border-radius: 12px;
            border-left: 3px solid var(--secondary-color); /* Warm amber accent border */
        }

        .feature {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .feature-icon {
            background: rgba(255, 255, 255, 0.2);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
            border: 1px solid rgba(255, 255, 255, 0.3); /* Subtle border */
        }

        .feature-text {
            font-size: 0.9rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .chat-container {
            width: 62%; /* Adjusted width to match sidebar increase */
            display: flex;
            flex-direction: column;
            background-color: var(--white);
            /* Add very subtle texture */
            background-image: var(--travel-texture);
            background-repeat: repeat;
        }

        .chat-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(217, 119, 6, 0.2); /* Rustic border color */
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent */
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .test-webhook-btn {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(217, 119, 6, 0.2);
        }

        .test-webhook-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(217, 119, 6, 0.3);
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
        }

        .chat-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: 0.2px; /* Slight letter spacing for rustic feel */
        }

        .chat-status {
            font-size: 0.875rem;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background-color: #10b981; /* Changed to green for universal "online" color */
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        


        .chat-body {
            flex: 1;
            padding: 1.5rem 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 80%;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .agent-message {
            align-self: flex-start;
        }

        .user-message {
            align-self: flex-end;
        }

        .message-content {
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            line-height: 1.5;
        }

        .agent-message .message-content {
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-bottom-left-radius: 4px;
            border-left: 2px solid var(--secondary-color); /* Warm amber accent */
        }

        .error-message {
            background-color: #FEF2F2 !important;
            border: 1px solid #FCA5A5 !important;
            color: #B91C1C;
            font-style: italic;
        }

        .user-message .message-content {
            background-color: var(--primary-color);
            color: var(--white);
            border-bottom-right-radius: 4px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            align-self: flex-start;
            background-color: #F9FAFB;
            padding: 0.75rem 1rem;
            border-radius: 16px;
            border: 1px solid #E5E7EB;
            margin-bottom: 1.5rem;
            display: none;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-light);
            border-radius: 50%;
            margin-right: 5px;
            animation: typing 1.5s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
            margin-right: 0;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .chat-input-container {
            padding: 1.5rem 2rem;
            border-top: 1px solid rgba(217, 119, 6, 0.2); /* Rustic border color */
            background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent */
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 999px;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0.5rem 0;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
        }

        .chat-input:focus {
            outline: none;
        }

        .send-button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            background-color: var(--primary-dark);
        }

        .send-button:disabled {
            background-color: var(--text-light);
            cursor: not-allowed;
        }

        .send-icon {
            width: 18px;
            height: 18px;
        }

        /* Options component for multiple choice */
        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .option-button {
            background-color: var(--white);
            border: 1px solid var(--primary-light);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-button:hover {
            background-color: var(--primary-color);
            color: var(--white);
        }

        /* Disabled option buttons */
        .option-button:disabled,
        .option-button.disabled {
            background-color: #f5f5f5 !important;
            color: #999 !important;
            border-color: #ddd !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            opacity: 0.5 !important;
        }
        
        .option-button:disabled:hover,
        .option-button.disabled:hover {
            background-color: #f5f5f5 !important;
            color: #999 !important;
        }

        /* Enhanced styling for day allocation option buttons */
        .options-container[data-question-id*="destinationDays"] .option-button {
            background: linear-gradient(135deg, var(--white), rgba(79, 70, 229, 0.05));
            border: 2px solid var(--primary-light);
            padding: 12px 20px;
            font-weight: 500;
            font-size: 0.9rem;
            min-width: 80px;
            position: relative;
            overflow: hidden;
        }

        .options-container[data-question-id*="destinationDays"] .option-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .options-container[data-question-id*="destinationDays"] .option-button:hover:before {
            left: 100%;
        }

        .options-container[data-question-id*="destinationDays"] .option-button:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            border-color: var(--primary-dark);
        }

        /* Day context card styling */
        .day-context-card {
            animation: slideInFromTop 0.3s ease-out;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Add rustic styling to confirmation summary */
        .confirmation-summary {
            background-color: #F9FAFB;
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid var(--secondary-color); /* Use warm amber */
            background-image: var(--travel-texture);
        }

        .confirmation-item {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .confirmation-label {
            font-weight: 600;
            color: var(--accent-color); /* Use rich brown for labels */
            min-width: 120px;
            margin-right: 10px;
        }

        .confirmation-value {
            color: var(--text-color);
            flex: 1;
            word-break: break-word;
        }

        /* Calendar picker styles with travel accents */
        .calendar-picker {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
            max-width: 350px;
            border: 1px solid rgba(217, 119, 6, 0.2);
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.6);
        }

        .day-option {
            padding: 10px 5px;
            border: 1px solid var(--primary-light);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: var(--white);
            color: var(--primary-color);
            font-size: 0.8rem;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-option:hover {
            background-color: var(--primary-light);
            color: var(--white);
        }

        .day-option.selected {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 500;
            border-color: var(--primary-dark);
        }

        .day-header {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        /* Correction messages */
        .correction-message {
            background-color: #E8F4FD;
            border: 1px solid #B3E0FF;
            color: #0075CC;
            font-style: italic;
            font-size: 0.9em;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
                width: 100%;
                border-radius: 0;
            }

            .sidebar {
                width: 100%;
                height: auto;
                padding: 1.5rem;
                max-height: 60vh; /* Limit sidebar height on mobile */
                overflow-y: auto; /* Allow scrolling within sidebar if needed */
            }

            .chat-container {
                width: 100%;
                height: auto; /* Allow chat container to expand */
                min-height: 40vh; /* Ensure chat area is visible */
            }

            .tagline {
                font-size: 1.5rem;
            }

            .features {
                display: block; /* Keep features visible on mobile */
                margin-bottom: 1rem;
            }
            
            /* Ensure the content container takes full height but allows scrolling */
            .content-container.visible {
                height: 100%;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* iPhone-specific styles - make survey form more prominent */
        @media (max-width: 428px) {
            .sidebar {
                max-height: 30vh; /* Further limit sidebar height on iPhone */
                padding: 1rem;
            }
            
            .logo {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            
            .tagline {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
            }
            
            .description {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }
            
            .features {
                display: none; /* Hide features on iPhone */
            }
            
            .chat-container {
                min-height: 70vh; /* Make chat container take more space */
            }
            
            .chat-header {
                position: sticky;
                top: 0;
                z-index: 10;
                background-color: #ffffff;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .chat-input-container {
                background-color: #ffffff;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            }
        }

        /* Language selector styles */
        .language-selector-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .language-selector-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            /* Add subtle texture */
            background-image: var(--travel-texture);
            border: 1px solid rgba(217, 119, 6, 0.2);
        }

        .language-selector-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .language-selector-description {
            font-size: 1rem;
            margin-bottom: 2rem;
            color: var(--text-light);
        }

        .language-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .language-button {
            padding: 0.75rem 1.5rem;
            border-radius: 999px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 140px;
        }

        .lang-en {
            background-color: var(--primary-color);
            color: var(--white);
            border: 1px solid var(--primary-color);
        }

        .lang-en:hover {
            background-color: var(--primary-dark);
        }

        .lang-es {
            background-color: var(--white);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .lang-es:hover {
            background-color: var(--primary-light);
            color: var(--white);
        }

        .language-flag {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            border-radius: 50%;
            overflow: hidden;
        }

        /* Hide all content initially */
        .content-container {
            display: none; /* Initially hidden */
        }

        /* When content is visible */
        .content-container.visible {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
        }
    </style>

    <!-- Add a travel-themed SVG pattern for texture -->
    <svg style="width:0;height:0;position:absolute;" aria-hidden="true" focusable="false">
        <defs>
            <pattern id="travel-pattern" width="200" height="200" patternUnits="userSpaceOnUse">
                <rect width="200" height="200" fill="rgba(217,119,6,0.05)"/>
                <g fill="none" stroke="rgba(146,64,14,0.03)" stroke-width="1">
                    <circle cx="50" cy="50" r="3"/>
                    <circle cx="150" cy="75" r="2"/>
                    <circle cx="100" cy="125" r="2.5"/>
                    <circle cx="25" cy="175" r="2"/>
                    <circle cx="175" cy="25" r="1.5"/>
                    <path d="M30 30 L 40 40"/>
                    <path d="M160 60 L 170 70"/>
                    <path d="M80 100 L 90 110"/>
                </g>
            </pattern>
        </defs>
    </svg>
</head>
<body>
    <!-- Language selector overlay -->
    <div class="language-selector-overlay" id="languageSelector">
        <div class="language-selector-container">
            <h2 class="language-selector-title">Choose Your Language / Elija su Idioma</h2>
            <p class="language-selector-description">Please select your preferred language to continue / Por favor seleccione su idioma preferido para continuar</p>
            <div class="language-buttons">
                <button class="language-button lang-en" onclick="selectLanguage('en')">
                    <span class="language-flag">ðŸ‡ºðŸ‡¸</span>
                    English
                </button>
                <button class="language-button lang-es" onclick="selectLanguage('es')">
                    <span class="language-flag">ðŸ‡ªðŸ‡¸</span>
                    EspaÃ±ol
                </button>
            </div>
        </div>
    </div>

    <!-- Main content container (initially hidden) - English Version -->
    <div class="content-container" id="contentEN">
        <div class="container">
            <div class="sidebar">
                <div class="sidebar-content">
                    <div class="logo">TravelPerfect Agent</div>
                    <h1 class="tagline">Your personal travel planning agent</h1>
                    <p class="description">Chat with our travel expert agent to create your perfect travel itinerary - personalized, detailed and ready to use.</p>
                    <div class="features">
                        <div class="feature">
                            <div class="feature-icon">âœ“</div>
                            <div class="feature-text">Personalized itineraries</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">âœ“</div>
                            <div class="feature-text">Local insights and recommendations</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">âœ“</div>
                            <div class="feature-text">Detailed day-by-day planning</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">âœ“</div>
                            <div class="feature-text">Expert travel guidance</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">Travel Planning Agent</div>
                    <div class="header-controls">
                        <div class="chat-status">
                            <div class="status-dot"></div>
                            <span>Online</span>
                        </div>
                    </div>
                </div>

                <div class="chat-body" id="chatBody">
                    <!-- Messages will appear here -->
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." autocomplete="off">
                        <button id="sendButton" class="send-button">
                            <svg class="send-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Spanish content container (initially hidden) -->
    <div class="content-container" id="contentES">
        <div class="container">
            <div class="sidebar">
                <div class="sidebar-content">
                    <div class="logo">Agente TravelPerfect</div>
                    <h1 class="tagline">Tu agente personal de planificaciÃ³n de viajes</h1>
                    <p class="description">Chatea con nuestro agente experto en viajes para crear tu itinerario de viaje perfecto - personalizado, detallado y listo para usar.</p>
                    <div class="features">
                        <div class="feature">
                            <div class="feature-icon">âœ“</div>
                            <div class="feature-text">Itinerarios personalizados</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">âœ“</div>
                            <div class="feature-text">Conocimientos locales y recomendaciones</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">âœ“</div>
                            <div class="feature-text">PlanificaciÃ³n detallada dÃ­a a dÃ­a</div>
                        </div>
                        <div class="feature">
                            <div class="feature-icon">âœ“</div>
                            <div class="feature-text">OrientaciÃ³n experta de viajes</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">Agente de PlanificaciÃ³n de Viajes</div>
                    <div class="header-controls">

                        <div class="chat-status">
                            <div class="status-dot"></div>
                            <span>En lÃ­nea</span>
                        </div>
                    </div>
                </div>

                <div class="chat-body" id="chatBodyES">
                    <!-- Messages will appear here -->
                </div>

                <div class="typing-indicator" id="typingIndicatorES">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <input type="text" id="chatInputES" class="chat-input" placeholder="Escribe tu mensaje..." autocomplete="off">
                        <button id="sendButtonES" class="send-button">
                            <svg class="send-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Language selection functionality
        function selectLanguage(lang) {
            // Hide language selector
            document.getElementById('languageSelector').style.display = 'none';
            
            // Show appropriate content
            if (lang === 'en') {
                const contentEN = document.getElementById('contentEN');
                contentEN.style.display = 'flex';
                contentEN.classList.add('visible');
                initializeChat('en');
            } else if (lang === 'es') {
                const contentES = document.getElementById('contentES');
                contentES.style.display = 'flex';
                contentES.classList.add('visible');
                initializeChat('es');
            }
        }
        
        // Conversation state (will be set based on language)
        let conversationId, messageHistory, formData, currentQuestion, questions;
        
        // Variables for tracking corrections
        let fieldsToCorrect = [];
        let currentCorrectionIndex = 0;
        
        // Initialize chat based on selected language
        function initializeChat(lang) {
            // Reset conversation state
            conversationId = Date.now().toString();
            messageHistory = [];
            formData = {};
            currentQuestion = 0;
            
            // CLEANUP: Remove any test webhook buttons and fix status dot color
            setTimeout(() => {
                // Remove test webhook buttons
                const testWebhookBtns = document.querySelectorAll('.test-webhook-btn, #testWebhook, #testWebhookES, [id*="testWebhook"]');
                testWebhookBtns.forEach(btn => {
                    console.log('Removing test webhook button:', btn);
                    btn.remove();
                });
                
                // Change status dots to green (universal online color)
                const statusDots = document.querySelectorAll('.status-dot');
                statusDots.forEach(dot => {
                    dot.style.backgroundColor = '#10b981';
                });
            }, 100);
            
            // Set elements and questions based on language
            if (lang === 'en') {
                chatBody = document.getElementById('chatBody');
                chatInput = document.getElementById('chatInput');
                sendButton = document.getElementById('sendButton');
                typingIndicator = document.getElementById('typingIndicator');
                questions = questionsEN;
            } else if (lang === 'es') {
                chatBody = document.getElementById('chatBodyES');
                chatInput = document.getElementById('chatInputES');
                sendButton = document.getElementById('sendButtonES');
                typingIndicator = document.getElementById('typingIndicatorES');
                questions = questionsES;
            }
            
            // Display first message from agent
            addAgentMessage(questions[0].text);
            
            // Add event listeners
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // CLEANUP: Remove test webhook buttons and fix status dot color
            setTimeout(() => {
                const testWebhookBtns = document.querySelectorAll('.test-webhook-btn, #testWebhook, #testWebhookES');
                testWebhookBtns.forEach(btn => btn.remove());
                
                const statusDots = document.querySelectorAll('.status-dot');
                statusDots.forEach(dot => dot.style.backgroundColor = '#10b981');
            }, 100);
            
            // Focus the input
            chatInput.focus();
        }
        
        // Core DOM elements
        let chatBody, chatInput, sendButton, typingIndicator;
        
        // Form validation utilities
        const validators = {
            fullName: (value) => {
                const words = value.trim().split(/\s+/);
                return {
                    isValid: words.length >= 2 && words[0].length > 0 && words[1].length > 0,
                    errorMessage: "Please enter your full name (both first and last name).",
                    errorMessageES: "Por favor ingrese su nombre completo (nombre y apellido)."
                };
            },
            email: (value) => {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return {
                    isValid: emailRegex.test(value),
                    errorMessage: "Please enter a valid email address (e.g., name@example.com).",
                    errorMessageES: "Por favor ingrese un correo electrÃ³nico vÃ¡lido (ej., nombre@ejemplo.com)."
                };
            },
            required: (value) => {
                return {
                    isValid: value.trim().length > 0,
                    errorMessage: "This field is required. Please provide a response.",
                    errorMessageES: "Este campo es obligatorio. Por favor proporcione una respuesta."
                };
            }
        };
        
        // Webhook configuration - points to our travel webhook endpoint
        const webhookUrl = 'https://n8n.srv854905.hstgr.cloud/webhook/travel-chat';
        
        // Test webhook functionality removed - using submit button at end of form instead
        
        // Questions for travel planning form in English
        const questionsEN = [
            { 
                id: 'greeting',
                text: "Hi there! I'm your personal travel planning agent. I'll help you create a personalized travel itinerary that's perfect for your needs. What's your full name (first and last name)?",
                field: 'Full Name',
                validation: 'fullName'
            },
            { 
                id: 'email',
                text: "Nice to meet you, {Full Name}! Please share your email address so we can send you the completed itinerary.",
                field: 'Email',
                validation: 'email'
            },
            {
                id: 'origin',
                text: "Where will you be traveling from? This helps me plan transportation options better.",
                field: 'Origin',
                validation: 'required'
            },
            { 
                id: 'destinationMultiple',
                text: "Great! Now, where are you planning to travel to? (If visiting multiple destinations, please list them in order of visit)",
                field: 'Destinations',
                multiDestination: true,
                validation: 'required',
                nextQuestionBranch: {
                    'multiDestination': 'startDate',
                    'singleDestination': 'destinationSpecificity'
                }
            },
            { 
                id: 'destinationSpecificity',
                text: "Would you like to explore specific areas or neighborhoods within your destination?",
                field: 'Destination Specificity',
                options: ['Yes, specific areas', 'No, general exploration'],
                skipIf: 'isMultiDestination'
            },

            { 
                id: 'startDate',
                text: "When would you like to start your trip? Please select your departure date.",
                field: 'Start Date',
                isCalendarPicker: true,
                validation: 'required'
            },
            { 
                id: 'endDate',
                text: "When would you like to return? Please select your return date.",
                field: 'End Date',
                isCalendarPicker: true,
                validation: 'required',
                nextQuestionBranch: {
                    'multiDestination': 'destinationDaysAllocation',
                    'singleDestination': 'travelers'
                }
            },
            { 
                id: 'destinationDaysAllocation',
                text: "Now let's plan how many days you'll spend in each destination. This helps me create a perfectly balanced itinerary.",
                field: 'Day Allocation Setup',
                isDayAllocationSetup: true,
                skipIf: 'singleDestination',
                isPreludeMessage: true // FIXED: No response required, just a setup message
            },
            { 
                id: 'travelers',
                text: "How many people are traveling?",
                field: 'Number of Travelers',
                options: ['1', '2', '3', '4', '5', '6+']
            },
            { 
                id: 'ages',
                text: "What are the ages of the travelers? This helps me recommend age-appropriate activities.",
                field: 'Ages of Travelers',
                options: ['Children (0-12)', 'Teenagers (13-17)', 'Young Adults (18-35)', 'Middle-Aged (36-64)', 'Seniors (65+)', 'Mixed Ages'],
                multiselect: true
            },
            { 
                id: 'budget',
                text: "What's your approximate total budget for this trip (in USD)?",
                field: 'Total Budget ($)',
                validation: 'required'
            },
            { 
                id: 'bookedInAdvanceYesNo',
                text: "Have you booked anything in advance for this trip?",
                field: 'Has Booked in Advance',
                options: ['Yes', 'No'],
                nextQuestionBranch: {
                    'Yes': 'bookedInAdvance',
                    'No': 'accommodation'
                }
            },
            { 
                id: 'bookedInAdvance',
                text: "Select all that apply:",
                field: 'Booked in Advance',
                multiselect: true,
                options: ['Flights', 'Hotels/Accommodation', 'Rental Car', 'Train/Bus Tickets', 'Activities/Tours', 'Restaurant Reservations', 'Event Tickets', 'Travel Insurance', 'Other'],
                nextQuestionBranch: {
                    'Other': 'bookedOtherDetails',
                    'default': 'accommodation'
                },
                contextAware: true
            },
            { 
                id: 'bookedOtherDetails',
                text: "Please describe the other items you've booked:",
                field: 'Other Booking Details',
                validation: 'required'
            },
            { 
                id: 'accommodation',
                text: "What type of accommodation do you prefer?",
                field: 'Preferred Accommodation',
                options: ['Hotel', 'Airbnb/Rental', 'Hostel', 'Resort', 'Other'],
                contextAwareText: {
                    'hasBookedAccommodation': "What type of accommodation do you prefer? (Just in case)"
                },
                conditional: 'showAccommodationQuestion'
            },
            { 
                id: 'transportation',
                text: "How would you prefer to get around during your trip?",
                field: 'Preferred Transportation',
                options: ['Public Transportation', 'Rental Car', 'Walking/Biking', 'Taxis/Rideshares', 'Mix of Options'],
                skipIf: 'hasBookedTransportation'
            },
            { 
                id: 'tripStyle',
                text: "What style of trip are you looking for? Select all that apply.",
                field: 'Trip Style (select all that apply)',
                multiselect: true,
                options: ['Relaxing & Spa', 'Adventurous & Outdoors', 'Cultural & Historical', 'Foodie & Culinary', 'Nightlife & Entertainment', 'Family-Friendly', 'Romantic & Couples', 'Budget-Conscious', 'Luxury & Premium', 'Photography & Instagram', 'Shopping & Fashion', 'Wellness & Fitness', 'Art & Museums', 'Music & Festivals', 'Nature & Wildlife', 'Beach & Water Sports', 'City Exploration', 'Off-the-Beaten-Path']
            },
            { 
                id: 'activityLevel',
                text: "What activity level are you comfortable with?",
                field: 'Activity Level',
                options: ['Low (lots of rest)', 'Moderate', 'High (busy schedule)']
            },
            { 
                id: 'mustSeeYesNo',
                text: "Are there any specific places or attractions you absolutely want to visit? (Recommended)",
                field: 'Has Must-See Places',
                options: ['Yes', 'No'],
                nextQuestionBranch: {
                    'Yes': 'mustSee',
                    'No': 'mustDoYesNo'
                }
            },
            { 
                id: 'mustSee',
                text: "Please tell me about the specific places or attractions you want to visit:",
                field: 'Must-See Places',
                validation: 'required'
            },
            { 
                id: 'mustDoYesNo',
                text: "Any specific activities you definitely want to do during your trip? (Recommended)",
                field: 'Has Must-Do Activities',
                options: ['Yes', 'No'],
                nextQuestionBranch: {
                    'Yes': 'mustDo',
                    'No': 'dietaryYesNo'
                }
            },
            { 
                id: 'mustDo',
                text: "Please describe the specific activities you want to do:",
                field: 'Must-Do Activities',
                validation: 'required'
            },
            { 
                id: 'dietaryYesNo',
                text: "Do you have any dietary restrictions or preferences I should know about?",
                field: 'Has Dietary Restrictions',
                options: ['Yes', 'No'],
                nextQuestionBranch: {
                    'Yes': 'dietaryDetails',
                    'No': 'interests'
                }
            },
            { 
                id: 'dietaryDetails',
                text: "Please describe your dietary restrictions or preferences:",
                field: 'Dietary Restrictions',
                validation: 'required'
            },
            { 
                id: 'interests',
                text: "What are your special interests? Select all that apply to help me personalize your experience.",
                field: 'Special Interests',
                multiselect: true,
                options: ['Ancient History', 'Modern History', 'Art Galleries', 'Street Art', 'Architecture', 'Museums', 'Local Markets', 'Shopping Districts', 'Nature Parks', 'Hiking Trails', 'Beaches', 'Mountains', 'Local Cuisine', 'Street Food', 'Wine Tasting', 'Coffee Culture', 'Live Music', 'Theater Shows', 'Festivals', 'Sports Events', 'Photography Spots', 'Sunset Views', 'Religious Sites', 'Local Traditions', 'Handicrafts', 'Bookstores', 'Libraries', 'Gardens', 'Zoos & Aquariums', 'Science Centers'],
                optional: true
            },
            { 
                id: 'freeTime',
                text: "How much free time would you like in your itinerary?",
                field: 'Free Time Preference',
                options: ['None (fully scheduled)', 'Some', 'Lots (minimal scheduling)']
            },
            {
                id: 'confirmationSummary',
                text: "Great! Here's a summary of your travel information. Please confirm these details are correct:",
                field: 'Confirmation',
                isConfirmation: true,
                options: ['Yes, create my itinerary', 'No, I need to make changes']
            },
            {
                id: 'whatToChange',
                text: "Which information would you like to correct? Select all that apply:",
                field: 'Information to Correct',
                multiselect: true,
                options: ['Full Name', 'Email', 'Origin', 'Destinations', 'Start Date', 'End Date', 'Number of Travelers', 'Ages of Travelers', 'Total Budget ($)']
            },
            { 
                id: 'final',
                text: "Thank you, {Full Name}! I'm creating your personalized travel itinerary now. Expect your detailed itinerary in your inbox soon at {Email}! This will include day-by-day plans, local recommendations, and everything you need for an amazing trip. If you have any questions, feel free to contact us!",
                field: 'Final'
            }
        ];
        
        // Questions for travel planning form in Spanish
        const questionsES = [
            { 
                id: 'greeting',
                text: "Â¡Hola! Soy tu agente personal de planificaciÃ³n de viajes. Te ayudarÃ© a crear un itinerario de viaje personalizado que sea perfecto para tus necesidades. Â¿CuÃ¡l es tu nombre completo (nombre y apellido)?",
                field: 'Nombre Completo',
                validation: 'fullName'
            },
            { 
                id: 'email',
                text: "Â¡Encantado de conocerte, {Nombre Completo}! Por favor, comparte tu direcciÃ³n de correo electrÃ³nico para que podamos enviarte el itinerario completo.",
                field: 'Correo ElectrÃ³nico',
                validation: 'email'
            },
            {
                id: 'origin',
                text: "Â¿Desde dÃ³nde viajarÃ¡s? Esto me ayuda a planificar mejor las opciones de transporte.",
                field: 'Origen',
                validation: 'required'
            },
            { 
                id: 'destinationMultiple',
                text: "Â¡Excelente! Ahora, Â¿a dÃ³nde planeas viajar? (Si visitas mÃºltiples destinos, por favor enumÃ©ralos en orden de visita)",
                field: 'Destinos',
                multiDestination: true,
                validation: 'required'
            },
            { 
                id: 'startDate',
                text: "Â¿CuÃ¡ndo te gustarÃ­a comenzar tu viaje? Por favor selecciona tu fecha de salida.",
                field: 'Fecha de Inicio',
                isCalendarPicker: true,
                validation: 'required'
            },
            { 
                id: 'endDate',
                text: "Â¿CuÃ¡ndo te gustarÃ­a regresar? Por favor selecciona tu fecha de regreso.",
                field: 'Fecha de Regreso',
                isCalendarPicker: true,
                validation: 'required'
            },
            { 
                id: 'travelers',
                text: "Â¿CuÃ¡ntas personas van a viajar?",
                field: 'NÃºmero de Viajeros',
                options: ['1', '2', '3', '4', '5', '6+']
            },
            { 
                id: 'ages',
                text: "Â¿CuÃ¡les son las edades de los viajeros? Esto me ayuda a recomendar actividades apropiadas para la edad.",
                field: 'Edades de los Viajeros',
                options: ['NiÃ±os (0-12)', 'Adolescentes (13-17)', 'Adultos JÃ³venes (18-35)', 'Mediana Edad (36-64)', 'Adultos Mayores (65+)', 'Edades Mixtas'],
                multiselect: true
            },
            { 
                id: 'budget',
                text: "Â¿CuÃ¡l es tu presupuesto total aproximado para este viaje (en USD)?",
                field: 'Presupuesto Total ($)',
                validation: 'required'
            },
            { 
                id: 'bookedInAdvance',
                text: "Â¿Has reservado algo por adelantado para este viaje?",
                field: 'Reservado por Adelantado',
                options: ['SÃ­', 'No'],
                nextQuestionBranch: {
                    'SÃ­': 'bookedDetails',
                    'No': 'accommodation'
                }
            },
            { 
                id: 'bookedDetails',
                text: "Por favor describe lo que ya has reservado (vuelos, hoteles, actividades, etc.):",
                field: 'Detalles de Reservas',
                validation: 'required'
            },
            { 
                id: 'accommodation',
                text: "Â¿QuÃ© tipo de alojamiento prefieres?",
                field: 'Alojamiento Preferido',
                options: ['Hotel', 'Airbnb/Alquiler', 'Hostal', 'Resort', 'Otro'],
                skipIf: 'hasBookedHotel'
            },
            { 
                id: 'transportation',
                text: "Â¿CÃ³mo prefieres moverte durante tu viaje?",
                field: 'Transporte Preferido',
                options: ['Transporte PÃºblico', 'Auto de Alquiler', 'Caminar/Bicicleta', 'Taxis/Rideshares', 'Mezcla de Opciones'],
                skipIf: 'hasBookedTransportation'
            },
            { 
                id: 'tripStyle',
                text: "Â¿QuÃ© estilo de viaje buscas? Selecciona todo lo que aplique.",
                field: 'Estilo de Viaje (selecciona todo lo que aplique)',
                multiselect: true,
                options: ['Relajante', 'Aventurero', 'Cultural', 'GastronÃ³mico', 'Vida Nocturna', 'Familiar', 'RomÃ¡ntico', 'EconÃ³mico', 'Lujo']
            },
            { 
                id: 'activityLevel',
                text: "Â¿Con quÃ© nivel de actividad te sientes cÃ³modo?",
                field: 'Nivel de Actividad',
                options: ['Bajo (mucho descanso)', 'Moderado', 'Alto (horario ocupado)']
            },
            { 
                id: 'mustSeeYesNo',
                text: "Â¿Hay lugares especÃ­ficos o atracciones que absolutamente quieras visitar? (Recomendado)",
                field: 'Tiene Lugares Imperdibles',
                options: ['SÃ­', 'No'],
                nextQuestionBranch: {
                    'SÃ­': 'mustSee',
                    'No': 'mustDoYesNo'
                }
            },
            { 
                id: 'mustSee',
                text: "Por favor cuÃ©ntame sobre los lugares especÃ­ficos o atracciones que quieres visitar:",
                field: 'Lugares Imperdibles',
                validation: 'required'
            },
            { 
                id: 'mustDoYesNo',
                text: "Â¿Alguna actividad especÃ­fica que definitivamente quieras hacer durante tu viaje? (Recomendado)",
                field: 'Tiene Actividades Imperdibles',
                options: ['SÃ­', 'No'],
                nextQuestionBranch: {
                    'SÃ­': 'mustDo',
                    'No': 'dietaryYesNo'
                }
            },
            { 
                id: 'mustDo',
                text: "Por favor describe las actividades especÃ­ficas que quieres hacer:",
                field: 'Actividades Imperdibles',
                validation: 'required'
            },
            { 
                id: 'dietaryYesNo',
                text: "Â¿Tienes alguna restricciÃ³n dietÃ©tica o preferencia que deba conocer?",
                field: 'Tiene Restricciones DietÃ©ticas',
                options: ['SÃ­', 'No'],
                nextQuestionBranch: {
                    'SÃ­': 'dietaryDetails',
                    'No': 'interests'
                }
            },
            { 
                id: 'dietaryDetails',
                text: "Por favor describe tus restricciones dietÃ©ticas o preferencias:",
                field: 'Restricciones DietÃ©ticas',
                validation: 'required'
            },
            { 
                id: 'interests',
                text: "Â¿CuÃ¡les son tus intereses especiales? (Historia, arte, naturaleza, compras, etc.)",
                field: 'Intereses Especiales',
                optional: true
            },
            { 
                id: 'freeTime',
                text: "Â¿CuÃ¡nto tiempo libre te gustarÃ­a tener en tu itinerario?",
                field: 'Preferencia de Tiempo Libre',
                options: ['Ninguno (completamente programado)', 'Algo', 'Mucho (programaciÃ³n mÃ­nima)']
            },
            {
                id: 'confirmationSummary',
                text: "Â¡Genial! AquÃ­ tienes un resumen de tu informaciÃ³n de viaje. Por favor, confirma que estos detalles son correctos:",
                field: 'ConfirmaciÃ³n',
                isConfirmation: true,
                options: ['SÃ­, crea mi itinerario', 'No, necesito hacer cambios']
            },
            {
                id: 'whatToChange',
                text: "Â¿QuÃ© informaciÃ³n te gustarÃ­a corregir? Selecciona todo lo que corresponda:",
                field: 'InformaciÃ³n a Corregir',
                multiselect: true,
                options: ['Nombre Completo', 'Correo ElectrÃ³nico', 'Origen', 'Destinos', 'Fecha de Inicio', 'Fecha de Regreso', 'NÃºmero de Viajeros', 'Edades de los Viajeros', 'Presupuesto Total ($)']
            },
            { 
                id: 'final',
                text: "Â¡Gracias, {Nombre Completo}! Estoy creando tu itinerario de viaje personalizado ahora. Â¡Espera tu itinerario detallado en tu bandeja de entrada pronto en {Correo ElectrÃ³nico}! Esto incluirÃ¡ planes dÃ­a a dÃ­a, recomendaciones locales y todo lo que necesitas para un viaje increÃ­ble. Â¡Si tienes alguna pregunta, no dudes en contactarnos!",
                field: 'Final'
            }
        ];

        // Send message function
        function sendMessage() {
            // ðŸ” DEBUG: Track form progress
            console.log(`ðŸ“ Current Question: ${currentQuestion + 1}/${questions.length}`);
            console.log(`ðŸŽ¯ Question ID: ${questions[currentQuestion]?.id}`);
            console.log(`ðŸ“ Question Text: ${questions[currentQuestion]?.text.substring(0, 50)}...`);
            
            const userMessage = chatInput.value.trim();
            
            // Don't send empty messages
            if (!userMessage) return;
            
            const currentQ = questions[currentQuestion];
            
            // Validate input if validation is specified
            if (currentQ.validation) {
                const validator = validators[currentQ.validation];
                if (validator) {
                    const validationResult = validator(userMessage);
                    if (!validationResult.isValid) {
                        // Show validation error message based on language
                        const errorMessage = questions === questionsEN ? 
                            validationResult.errorMessage : 
                            validationResult.errorMessageES;
                        addAgentMessage(errorMessage, null, null, true);
                        return;
                    }
                }
            }
            
            // Add user message to chat
            addUserMessage(userMessage);
            chatInput.value = '';
            
            // Disable all option buttons for previous questions
            disablePreviousOptions();
            
            // Process user response for current question
            const handledQuestionAdvancement = processUserResponse(userMessage, currentQ);
            
            // Show typing indicator
            showTypingIndicator();
            
            // Move to next question or submit data
            setTimeout(() => {
                // If the response handling function already updated the currentQuestion, don't proceed with normal flow
                if (handledQuestionAdvancement) {
                    const nextQ = questions[currentQuestion];
                    
                    // If we're in correction mode, use custom correction prompts
                    let nextText;
                    if (isCorrectingField()) {
                        const lang = questions === questionsEN ? 'en' : 'es';
                        nextText = getCorrectionPrompt(fieldsToCorrect[currentCorrectionIndex-1], lang);
                    } else {
                        // Use context-aware text if available, otherwise use default text
                        nextText = getContextAwareText(nextQ);
                        
                        // Replace any placeholder text with actual user input
                        for (const field in formData) {
                            nextText = nextText.replace(`{${field}}`, formData[field]);
                        }
                    }
                    
                    hideTypingIndicator();
                    addAgentMessage(nextText, nextQ.options, nextQ.multiselect);
                    return;
                }
                
                // Check if there's branch logic based on the response
                let nextQuestionId;
                if (currentQ.nextQuestionBranch) {
                    // Special handling for endDate question - branch based on destination type
                    if (currentQ.id === 'endDate') {
                        if (window.isMultiDestination && currentQ.nextQuestionBranch['multiDestination']) {
                            nextQuestionId = currentQ.nextQuestionBranch['multiDestination'];
                        } else if (!window.isMultiDestination && currentQ.nextQuestionBranch['singleDestination']) {
                            nextQuestionId = currentQ.nextQuestionBranch['singleDestination'];
                        }
                    }
                    // Special handling for destinationMultiple question - branch based on destination count
                    else if (currentQ.id === 'destinationMultiple') {
                        if (window.isMultiDestination && currentQ.nextQuestionBranch['multiDestination']) {
                            nextQuestionId = currentQ.nextQuestionBranch['multiDestination'];
                        } else if (!window.isMultiDestination && currentQ.nextQuestionBranch['singleDestination']) {
                            nextQuestionId = currentQ.nextQuestionBranch['singleDestination'];
                        }
                    }
                    // Standard branching based on response value
                    else if (formData[currentQ.field] in currentQ.nextQuestionBranch) {
                        nextQuestionId = currentQ.nextQuestionBranch[formData[currentQ.field]];
                    }
                    
                    // Find the index of the next question if we have a target
                    if (nextQuestionId) {
                        const nextIndex = questions.findIndex(q => q.id === nextQuestionId);
                        if (nextIndex !== -1) {
                            currentQuestion = nextIndex;
                        } else {
                            // Fallback to sequential if branch target not found
                            currentQuestion++;
                        }
                    } else {
                        // Default sequential behavior
                        currentQuestion++;
                    }
                } else {
                    // Default sequential behavior
                    currentQuestion++;
                }
                
                // Skip questions based on booking analysis
                while (currentQuestion < questions.length && shouldSkipQuestion(questions[currentQuestion])) {
                    currentQuestion++;
                }
                
                if (currentQuestion < questions.length) {
                    const nextQ = questions[currentQuestion];
                    
                    // Check if this is the final question
                    if (nextQ.id === 'final') {
                        console.log('ðŸŽ¯ REACHED FINAL QUESTION - CREATING SUBMIT BUTTON');
                        console.log('ðŸŽ¯ Final question text:', nextQ.text);
                        
                        // Hide the regular input and send button
                        chatInput.style.display = 'none';
                        sendButton.style.display = 'none';
                        
                        // Create and show the submit button
                        createSubmitButton();
                        
                        // Don't process this as a regular question - just show the message and button
                        hideTypingIndicator();
                        
                        // Use context-aware text if available, otherwise use default text
                        let finalText = getContextAwareText(nextQ);
                        
                        // Replace any placeholder text with actual user input
                        for (const field in formData) {
                            finalText = finalText.replace(`{${field}}`, formData[field]);
                        }
                        
                        addAgentMessage(finalText, null, false);
                        
                        // SIMPLE SUBMIT BUTTON: Add directly to chat body
                        setTimeout(() => {
                            const chatBody = document.getElementById('chatBody') || document.getElementById('chatBodyES');
                            if (chatBody) {
                                const submitDiv = document.createElement('div');
                                submitDiv.className = 'submit-button-container';
                                submitDiv.style.cssText = 'text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(217, 119, 6, 0.05)); border-radius: 10px; margin: 20px 0; border-top: 1px solid rgba(79, 70, 229, 0.2);';
                                
                                const submitBtn = document.createElement('button');
                                submitBtn.innerHTML = questions === questionsEN ? 'ðŸš€ Create My Travel Itinerary' : 'ðŸš€ Crear Mi Itinerario de Viaje';
                                submitBtn.style.cssText = 'background: linear-gradient(135deg, #4f46e5, #d97706); color: white; border: none; padding: 16px 32px; border-radius: 25px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); min-width: 280px; transition: all 0.3s ease;';
                                
                                submitBtn.onmouseenter = () => {
                                    submitBtn.style.transform = 'translateY(-2px)';
                                    submitBtn.style.boxShadow = '0 6px 20px rgba(79, 70, 229, 0.4)';
                                };
                                
                                submitBtn.onmouseleave = () => {
                                    submitBtn.style.transform = 'translateY(0)';
                                    submitBtn.style.boxShadow = '0 4px 15px rgba(79, 70, 229, 0.3)';
                                };
                                
                                submitBtn.onclick = () => {
                                    console.log('ðŸš€ SUBMIT BUTTON CLICKED!');
                                    submitBtn.disabled = true;
                                    submitBtn.innerHTML = questions === questionsEN ? 'â³ Creating Your Itinerary...' : 'â³ Creando Tu Itinerario...';
                                    submitBtn.style.background = 'linear-gradient(135deg, #6b7280, #9ca3af)';
                                    
                                    submitFormData().then(() => {
                                        submitBtn.innerHTML = questions === questionsEN ? 'âœ… Itinerary Request Sent!' : 'âœ… Â¡Solicitud de Itinerario Enviada!';
                                        submitBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                                    }).catch((error) => {
                                        console.error('âŒ Submit error:', error);
                                        submitBtn.innerHTML = questions === questionsEN ? 'âŒ Error - Please Try Again' : 'âŒ Error - IntÃ©ntalo de Nuevo';
                                        submitBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                                        submitBtn.disabled = false;
                                    });
                                };
                                
                                submitDiv.appendChild(submitBtn);
                                chatBody.appendChild(submitDiv);
                                chatBody.scrollTop = chatBody.scrollHeight;
                                
                                console.log('âœ… SUBMIT BUTTON ADDED TO CHAT BODY');
                            }
                        }, 500);
                        return; // Exit early - don't process as regular question
                    }
                    
                    // FIXED: Handle prelude messages in sendMessage to prevent duplicate processing
                    if (nextQ.isPreludeMessage) {
                        // Use context-aware text if available, otherwise use default text
                        let nextText = getContextAwareText(nextQ);
                        
                        // Replace any placeholder text with actual user input
                        for (const field in formData) {
                            nextText = nextText.replace(`{${field}}`, formData[field]);
                        }
                        hideTypingIndicator();
                        
                        // Display prelude message without options
                        addAgentMessage(nextText, null, false);
                        
                        // CRITICAL FIX: Generate day allocation questions for destinationDaysAllocation prelude
                        if (nextQ.id === 'destinationDaysAllocation') {
                            console.log('ðŸ” Processing destinationDaysAllocation prelude');
                            console.log('ðŸ” isMultiDestination:', window.isMultiDestination);
                            console.log('ðŸ” Start Date:', formData['Start Date']);
                            console.log('ðŸ” End Date:', formData['End Date']);
                            console.log('ðŸ” addedDynamicQuestions:', window.addedDynamicQuestions);
                            console.log('ðŸ” destinationList:', window.destinationList);
                            
                            // Generate dynamic questions for each destination
                            if (window.isMultiDestination && formData['Start Date'] && formData['End Date'] && !window.addedDynamicQuestions) {
                                const dayQuestions = generateSmartDayAllocationQuestions(window.destinationList);
                                
                                // Insert these questions after the current question
                                const insertIndex = currentQuestion + 1;
                                
                                // Add the dynamic day questions
                                questions.splice(insertIndex, 0, ...dayQuestions);
                                
                                // Set flag to track that we've added dynamic questions
                                window.addedDynamicQuestions = true;
                                
                                console.log(`ðŸŽ¯ Generated ${dayQuestions.length} day allocation questions for destinations:`, window.destinationList);
                                console.log('ðŸŽ¯ Day questions:', dayQuestions);
                                console.log('ðŸŽ¯ Questions array length after insertion:', questions.length);
                                console.log('ðŸŽ¯ Day questions:', dayQuestions);
                                console.log('ðŸŽ¯ Questions array length after insertion:', questions.length);
                            } else {
                                console.log('âŒ Day allocation questions NOT generated - conditions not met');
                                console.log('âŒ Condition check:');
                                console.log('   - isMultiDestination:', window.isMultiDestination);
                                console.log('   - Start Date exists:', !!formData['Start Date']);
                                console.log('   - End Date exists:', !!formData['End Date']);
                                console.log('   - addedDynamicQuestions:', window.addedDynamicQuestions);
                            }
                        }
                        
                        // Auto-advance to next question after delay
                        setTimeout(() => {
                            currentQuestion++;
                            
                            // Skip questions based on booking analysis
                            while (currentQuestion < questions.length && shouldSkipQuestion(questions[currentQuestion])) {
                                currentQuestion++;
                            }
                            
                            if (currentQuestion < questions.length) {
                                const followUpQ = questions[currentQuestion];
                                
                                // Use context-aware text if available, otherwise use default text
                                let followUpText = getContextAwareText(followUpQ);
                                
                                // Replace any placeholder text with actual user input
                                for (const field in formData) {
                                    followUpText = followUpText.replace(`{${field}}`, formData[field]);
                                }
                                
                                addAgentMessage(followUpText, followUpQ.options, followUpQ.multiselect);
                            }
                        }, 1500);
                        return; // Exit early for prelude messages
                    }
                    
                    // Use context-aware text if available, otherwise use default text
                    let nextText = getContextAwareText(nextQ);
                    
                    // Replace any placeholder text with actual user input
                    for (const field in formData) {
                        nextText = nextText.replace(`{${field}}`, formData[field]);
                    }
                    hideTypingIndicator();
                    addAgentMessage(nextText, nextQ.options, nextQ.multiselect);
                } else {
                    // FIXED: Force show submit button instead of fallback message
                    console.log('ðŸŽ¯ REACHED END OF QUESTIONS - SHOWING SUBMIT BUTTON');
                    console.log('ðŸŽ¯ currentQuestion:', currentQuestion, 'questions.length:', questions.length);
                    
                    hideTypingIndicator();
                    
                    // IMMEDIATE SUBMIT BUTTON - Add right here
                    setTimeout(() => {
                        console.log('ðŸŽ¯ ADDING IMMEDIATE SUBMIT BUTTON');
                        const chatBody = document.getElementById('chatBody') || document.getElementById('chatBodyES');
                        if (chatBody) {
                            const immediateSubmitDiv = document.createElement('div');
                            immediateSubmitDiv.className = 'submit-button-container immediate-submit';
                            immediateSubmitDiv.style.cssText = 'text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(217, 119, 6, 0.05)); border-radius: 10px; margin: 20px 0; border: 2px solid #4f46e5;';
                            
                            const immediateSubmitBtn = document.createElement('button');
                            immediateSubmitBtn.innerHTML = questions === questionsEN ? 'ðŸš€ Create My Travel Itinerary' : 'ðŸš€ Crear Mi Itinerario de Viaje';
                            immediateSubmitBtn.style.cssText = 'background: linear-gradient(135deg, #4f46e5, #d97706); color: white; border: none; padding: 16px 32px; border-radius: 25px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); min-width: 280px;';
                            
                            immediateSubmitBtn.onclick = () => {
                                console.log('ðŸš€ IMMEDIATE SUBMIT BUTTON CLICKED!');
                                immediateSubmitBtn.disabled = true;
                                immediateSubmitBtn.innerHTML = questions === questionsEN ? 'â³ Creating Your Itinerary...' : 'â³ Creando Tu Itinerario...';
                                immediateSubmitBtn.style.background = 'linear-gradient(135deg, #6b7280, #9ca3af)';
                                
                                submitFormData().then(() => {
                                    immediateSubmitBtn.innerHTML = questions === questionsEN ? 'âœ… Itinerary Request Sent!' : 'âœ… Â¡Solicitud de Itinerario Enviada!';
                                    immediateSubmitBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                                }).catch((error) => {
                                    console.error('âŒ Immediate submit error:', error);
                                    immediateSubmitBtn.innerHTML = questions === questionsEN ? 'âŒ Error - Please Try Again' : 'âŒ Error - IntÃ©ntalo de Nuevo';
                                    immediateSubmitBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                                    immediateSubmitBtn.disabled = false;
                                });
                            };
                            
                            immediateSubmitDiv.appendChild(immediateSubmitBtn);
                            chatBody.appendChild(immediateSubmitDiv);
                            chatBody.scrollTop = chatBody.scrollHeight;
                            
                            console.log('âœ… IMMEDIATE SUBMIT BUTTON ADDED');
                        }
                    }, 500);
                    
                    // Show the final thank you message
                    const finalMessage = questions === questionsEN ? 
                        `Thank you, ${formData['Full Name'] || 'valued customer'}! I'm creating your personalized travel itinerary now. Expect your detailed itinerary in your inbox soon at ${formData['Email'] || 'your email'}! This will include day-by-day plans, local recommendations, and everything you need for an amazing trip. If you have any questions, feel free to contact us!` : 
                        `Â¡Gracias, ${formData['Nombre Completo'] || 'estimado cliente'}! Estoy creando tu itinerario de viaje personalizado ahora. Â¡Espera tu itinerario detallado en tu bandeja de entrada pronto en ${formData['Correo ElectrÃ³nico'] || 'tu correo'}! Esto incluirÃ¡ planes dÃ­a a dÃ­a, recomendaciones locales y todo lo que necesitas para un viaje increÃ­ble. Â¡Si tienes alguna pregunta, no dudes en contactarnos!`;
                    
                    addAgentMessage(finalMessage, null, false);
                    
                    // DIRECT SUBMIT BUTTON INJECTION
                    setTimeout(() => {
                        const chatBody = document.getElementById('chatBody') || document.getElementById('chatBodyES');
                        const submitHTML = `
                            <div class="submit-button-container direct-submit" style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(217, 119, 6, 0.05)); border-radius: 10px; margin: 20px 0; border: 2px solid #4f46e5;">
                                <button onclick="handleDirectSubmit(this)" style="background: linear-gradient(135deg, #4f46e5, #d97706); color: white; border: none; padding: 16px 32px; border-radius: 25px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); min-width: 280px;">
                                    ðŸš€ ${questions === questionsEN ? 'Create My Travel Itinerary' : 'Crear Mi Itinerario de Viaje'}
                                </button>
                            </div>
                        `;
                        if (chatBody) {
                            chatBody.insertAdjacentHTML('beforeend', submitHTML);
                            chatBody.scrollTop = chatBody.scrollHeight;
                            console.log('âœ… DIRECT SUBMIT BUTTON INJECTED');
                        }
                    }, 1000);
                    
                    // Hide the regular input and send button
                    chatInput.style.display = 'none';
                    sendButton.style.display = 'none';
                    
                    // Create and show the submit button
                    createSubmitButton();
                    
                    // GUARANTEED SUBMIT BUTTON - Add directly after message
                    setTimeout(() => {
                        console.log('ðŸŽ¯ ADDING GUARANTEED SUBMIT BUTTON');
                        const chatBody = document.getElementById('chatBody') || document.getElementById('chatBodyES');
                        if (chatBody) {
                            const guaranteedSubmitDiv = document.createElement('div');
                            guaranteedSubmitDiv.className = 'submit-button-container guaranteed-submit';
                            guaranteedSubmitDiv.style.cssText = 'text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(217, 119, 6, 0.05)); border-radius: 10px; margin: 20px 0; border: 2px solid #4f46e5;';
                            
                            const guaranteedSubmitBtn = document.createElement('button');
                            guaranteedSubmitBtn.innerHTML = questions === questionsEN ? 'ðŸš€ Create My Travel Itinerary' : 'ðŸš€ Crear Mi Itinerario de Viaje';
                            guaranteedSubmitBtn.style.cssText = 'background: linear-gradient(135deg, #4f46e5, #d97706); color: white; border: none; padding: 16px 32px; border-radius: 25px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); min-width: 280px;';
                            
                            guaranteedSubmitBtn.onclick = () => {
                                console.log('ðŸš€ GUARANTEED SUBMIT BUTTON CLICKED!');
                                guaranteedSubmitBtn.disabled = true;
                                guaranteedSubmitBtn.innerHTML = questions === questionsEN ? 'â³ Creating Your Itinerary...' : 'â³ Creando Tu Itinerario...';
                                guaranteedSubmitBtn.style.background = 'linear-gradient(135deg, #6b7280, #9ca3af)';
                                
                                submitFormData().then(() => {
                                    guaranteedSubmitBtn.innerHTML = questions === questionsEN ? 'âœ… Itinerary Request Sent!' : 'âœ… Â¡Solicitud de Itinerario Enviada!';
                                    guaranteedSubmitBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                                }).catch((error) => {
                                    console.error('âŒ Guaranteed submit error:', error);
                                    guaranteedSubmitBtn.innerHTML = questions === questionsEN ? 'âŒ Error - Please Try Again' : 'âŒ Error - IntÃ©ntalo de Nuevo';
                                    guaranteedSubmitBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                                    guaranteedSubmitBtn.disabled = false;
                                });
                            };
                            
                            guaranteedSubmitDiv.appendChild(guaranteedSubmitBtn);
                            chatBody.appendChild(guaranteedSubmitDiv);
                            chatBody.scrollTop = chatBody.scrollHeight;
                            
                            console.log('âœ… GUARANTEED SUBMIT BUTTON ADDED');
                        }
                    }, 1500);
                    
                    // ADDITIONAL FALLBACK: Force add submit button after delay
                    setTimeout(() => {
                        if (!document.querySelector('.submit-button-container') && !document.querySelector('.submit-container')) {
                            console.log('ðŸ”§ FORCE ADDING SUBMIT BUTTON');
                            const chatBody = document.getElementById('chatBody') || document.getElementById('chatBodyES');
                            if (chatBody) {
                                const forceSubmitDiv = document.createElement('div');
                                forceSubmitDiv.className = 'submit-button-container force-submit';
                                forceSubmitDiv.style.cssText = 'text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(217, 119, 6, 0.05)); border-radius: 10px; margin: 20px 0; border-top: 1px solid rgba(79, 70, 229, 0.2);';
                                
                                const forceSubmitBtn = document.createElement('button');
                                forceSubmitBtn.innerHTML = questions === questionsEN ? 'ðŸš€ Create My Travel Itinerary' : 'ðŸš€ Crear Mi Itinerario de Viaje';
                                forceSubmitBtn.style.cssText = 'background: linear-gradient(135deg, #4f46e5, #d97706); color: white; border: none; padding: 16px 32px; border-radius: 25px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); min-width: 280px; transition: all 0.3s ease;';
                                
                                forceSubmitBtn.onclick = () => {
                                    console.log('ðŸš€ FORCE SUBMIT BUTTON CLICKED!');
                                    forceSubmitBtn.disabled = true;
                                    forceSubmitBtn.innerHTML = questions === questionsEN ? 'â³ Creating Your Itinerary...' : 'â³ Creando Tu Itinerario...';
                                    forceSubmitBtn.style.background = 'linear-gradient(135deg, #6b7280, #9ca3af)';
                                    
                                    submitFormData().then(() => {
                                        forceSubmitBtn.innerHTML = questions === questionsEN ? 'âœ… Itinerary Request Sent!' : 'âœ… Â¡Solicitud de Itinerario Enviada!';
                                        forceSubmitBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                                    }).catch((error) => {
                                        console.error('âŒ Force submit error:', error);
                                        forceSubmitBtn.innerHTML = questions === questionsEN ? 'âŒ Error - Please Try Again' : 'âŒ Error - IntÃ©ntalo de Nuevo';
                                        forceSubmitBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                                        forceSubmitBtn.disabled = false;
                                    });
                                };
                                
                                forceSubmitDiv.appendChild(forceSubmitBtn);
                                chatBody.appendChild(forceSubmitDiv);
                                chatBody.scrollTop = chatBody.scrollHeight;
                                
                                console.log('âœ… FORCE SUBMIT BUTTON ADDED');
                            }
                        }
                    }, 2000);
                    
                    // FALLBACK: Add submit button directly to chat body
                    setTimeout(() => {
                        const chatBody = document.getElementById('chatBody') || document.getElementById('chatBodyES');
                        if (chatBody && !document.querySelector('.submit-button-container')) {
                            const submitDiv = document.createElement('div');
                            submitDiv.className = 'submit-button-container';
                            submitDiv.style.cssText = 'text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(217, 119, 6, 0.05)); border-radius: 10px; margin: 20px 0;';
                            
                            const submitBtn = document.createElement('button');
                            submitBtn.innerHTML = 'ðŸš€ Submit My Travel Request';
                            submitBtn.style.cssText = 'background: linear-gradient(135deg, #4f46e5, #d97706); color: white; border: none; padding: 16px 32px; border-radius: 25px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); min-width: 280px;';
                            
                            submitBtn.onclick = () => {
                                submitBtn.disabled = true;
                                submitBtn.innerHTML = 'â³ Submitting...';
                                submitFormData().then(() => {
                                    submitBtn.innerHTML = 'âœ… Request Sent!';
                                    submitBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                                }).catch(() => {
                                    submitBtn.innerHTML = 'âŒ Error - Try Again';
                                    submitBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                                    submitBtn.disabled = false;
                                });
                            };
                            
                            submitDiv.appendChild(submitBtn);
                            chatBody.appendChild(submitDiv);
                            chatBody.scrollTop = chatBody.scrollHeight;
                        }
                    }, 1000);
                    
                    // FALLBACK: If createSubmitButton fails, add a simple button directly
                    setTimeout(() => {
                        if (!document.querySelector('.submit-container')) {
                            console.log('ðŸ”§ FALLBACK: Creating simple submit button');
                            const chatBody = document.getElementById('chatBody') || document.getElementById('chatBodyES');
                            if (chatBody) {
                                const simpleSubmitDiv = document.createElement('div');
                                simpleSubmitDiv.style.cssText = 'text-align: center; padding: 20px; background: #f9fafb; border-radius: 10px; margin: 20px 0;';
                                
                                const simpleSubmitBtn = document.createElement('button');
                                simpleSubmitBtn.innerHTML = 'ðŸš€ Submit My Travel Request';
                                simpleSubmitBtn.style.cssText = 'background: linear-gradient(135deg, #4f46e5, #d97706); color: white; border: none; padding: 16px 32px; border-radius: 25px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);';
                                
                                simpleSubmitBtn.onclick = () => {
                                    simpleSubmitBtn.disabled = true;
                                    simpleSubmitBtn.innerHTML = 'â³ Submitting...';
                                    submitFormData().then(() => {
                                        simpleSubmitBtn.innerHTML = 'âœ… Request Sent!';
                                        simpleSubmitBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                                    }).catch(() => {
                                        simpleSubmitBtn.innerHTML = 'âŒ Error - Try Again';
                                        simpleSubmitBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                                        simpleSubmitBtn.disabled = false;
                                    });
                                };
                                
                                simpleSubmitDiv.appendChild(simpleSubmitBtn);
                                chatBody.appendChild(simpleSubmitDiv);
                                chatBody.scrollTop = chatBody.scrollHeight;
                            }
                        }
                    }, 1000);
                }
            }, 300 + Math.random() * 300); // Reduced typing delay for better UX
        }
        
        // Process user response for a question
        function processUserResponse(response, question) {
            formData[question.field] = response;
            
            // Update message history
            messageHistory.push({
                role: 'user',
                content: response,
                question: question.id
            });
            
            // Smart question skipping based on booking details - FIX: Use correct question ID
            if (question.id === 'bookedInAdvance') {
                analyzeBookingDetails(response);
            }
            
            // Handle destination processing for multi-destination logic
            if (question.id === 'destinationMultiple') {
                const destinations = response.split(',').map(dest => dest.trim()).filter(dest => dest.length > 0);
                window.destinationList = destinations;
                window.isMultiDestination = destinations.length > 1;
                
                // Store destinations for later use
                formData['Destinations'] = destinations.join(', ');
                formData['IsMultiDestination'] = window.isMultiDestination;
                
                // Don't generate day questions yet - wait for end date
            }
            
            // NOTE: Day allocation setup is now handled as prelude message in sendMessage function
            
            // Handle "Other" booking details follow-up logic
            if (question.id === 'bookedInAdvance') {
                const bookingItems = response.split(',').map(item => item.trim());
                const hasOther = bookingItems.some(item => item.toLowerCase().includes('other'));
                
                if (!hasOther) {
                    // Skip the "Other" details question if "Other" wasn't selected
                    const otherDetailsIndex = questions.findIndex(q => q.id === 'bookedOtherDetails');
                    if (otherDetailsIndex !== -1) {
                        // Mark this question to be skipped
                        window.skipOtherDetails = true;
                    }
                }
            }
            
            // Special handling for confirmation response
            if (question.id === 'confirmationSummary') {
                // Handle based on language
                const isEnglish = questions === questionsEN;
                const yesOption = isEnglish ? 
                    'Yes, create my itinerary' : 
                    'SÃ­, crea mi itinerario';
                const noOption = isEnglish ? 
                    'No, I need to make changes' : 
                    'No, necesito hacer cambios';
                
                if (response === noOption) {
                    // Reset correction tracking variables
                    fieldsToCorrect = [];
                    currentCorrectionIndex = 0;
                    
                    // Set currentQuestion to the whatToChange question
                    const whatToChangeIndex = questions.findIndex(q => q.id === 'whatToChange');
                    if (whatToChangeIndex !== -1) {
                        currentQuestion = whatToChangeIndex;
                        return true; // Signal that we've handled the question advancement
                    }
                } else if (response === yesOption) {
                    // Go to final question
                    const finalIndex = questions.findIndex(q => q.id === 'final');
                    console.log('ðŸŽ¯ CONFIRMATION YES - Going to final question');
                    console.log('ðŸŽ¯ Final question index:', finalIndex);
                    console.log('ðŸŽ¯ Final question:', questions[finalIndex]);
                    if (finalIndex !== -1) {
                        currentQuestion = finalIndex;
                        return true; // Signal that we've handled the question advancement
                    } else {
                        console.error('âŒ Final question not found!');
                    }
                }
            }
            
            // Handle whatToChange response
            if (question.id === 'whatToChange') {
                // Parse selected fields to correct
                fieldsToCorrect = response.split(/,\s*/).map(field => field.trim());
                currentCorrectionIndex = 0;
                
                if (fieldsToCorrect.length > 0) {
                    // Set a flag indicating we're in correction mode
                    window.isInCorrectionMode = true;
                    
                    // Remember current language to maintain consistency
                    window.correctionLanguage = questions === questionsEN ? 'en' : 'es';
                    
                    // Find the question for the first field to correct
                    for (let i = 0; i < questions.length; i++) {
                        if (questions[i].field === fieldsToCorrect[currentCorrectionIndex]) {
                            currentQuestion = i;
                            
                            // Store the current position in the survey to return later
                            window.returnToQuestionAfterCorrection = questions.findIndex(q => q.id === 'confirmationSummary');
                            
                            return true; // Signal that we've handled the question advancement
                        }
                    }
                }
            }
            
            // Handle smart day allocation responses - FIXED remaining days update
            if (question.isSmartDayQuestion) {
                const selectedDays = dayOptionToNumber(response);
                
                // Update remaining days
                window.remainingDays = (window.remainingDays || 0) - selectedDays;
                
                // Store the allocation
                window.dayAllocations[question.destinationName] = selectedDays;
                
                console.log(`ðŸŽ¯ Day allocation: ${question.destinationName} = ${selectedDays} days, remaining = ${window.remainingDays}`);
                
                // Update the text of the next day allocation question if it exists
                const nextQuestionIndex = currentQuestion + 1;
                if (nextQuestionIndex < questions.length && questions[nextQuestionIndex].isSmartDayQuestion) {
                    const nextDestination = questions[nextQuestionIndex].destinationName;
                    questions[nextQuestionIndex].text = `How many days would you like to spend in ${nextDestination}? (You have ${window.remainingDays} days remaining)`;
                }
                
                // Check if this was the last destination
                const remainingDestinations = window.destinationList ? window.destinationList.length - question.destinationIndex - 1 : 0;
                
                if (remainingDestinations === 0) {
                    // All destinations allocated, add confirmation question
                    const confirmationQuestion = {
                        id: 'dayAllocationConfirmation',
                        text: "Perfect! Let me confirm your day allocation:",
                        field: 'Day Allocation Confirmation',
                        isDayAllocationConfirmation: true,
                        options: ['Yes, this looks perfect', 'No, I need to adjust the days']
                    };
                    
                    // Insert confirmation question after current question
                    questions.splice(currentQuestion + 1, 0, confirmationQuestion);
                }
            }
            
            // Handle day allocation confirmation - FIXED: Continue to next questions after confirmation
            if (question.isDayAllocationConfirmation) {
                if (response === 'No, I need to adjust the days') {
                    // Reset day allocations and go back to first day question
                    window.remainingDays = window.totalTripDays;
                    window.dayAllocations = {};
                    
                    // Find first day allocation question
                    for (let i = 0; i < questions.length; i++) {
                        if (questions[i].isSmartDayQuestion) {
                            currentQuestion = i;
                            return true;
                        }
                    }
                }
                // FIXED: If "Yes", remove the confirmation question and continue normally
                if (response === 'Yes, this looks perfect') {
                    // Remove this confirmation question from the array so it doesn't interfere
                    questions.splice(currentQuestion, 1);
                    currentQuestion--; // Adjust index since we removed a question
                    // Continue to next question normally
                }
            }
            
            // Handle field correction completion
            if (isCorrectingField()) {
                // Check if the current field being corrected matches the current question
                if (question.field === fieldsToCorrect[currentCorrectionIndex]) {
                    currentCorrectionIndex++;
                    
                    // If we've corrected all fields, return to the confirmation summary
                    if (currentCorrectionIndex >= fieldsToCorrect.length && window.returnToQuestionAfterCorrection) {
                        currentQuestion = window.returnToQuestionAfterCorrection;
                        fieldsToCorrect = [];
                        currentCorrectionIndex = 0;
                        window.isInCorrectionMode = false; // Reset correction mode flag
                        return true; // Signal that we've handled the question advancement
                    } else if (currentCorrectionIndex < fieldsToCorrect.length) {
                        // Move to the next field to correct
                        for (let i = 0; i < questions.length; i++) {
                            if (questions[i].field === fieldsToCorrect[currentCorrectionIndex]) {
                                currentQuestion = i;
                                return true; // Signal that we've handled the question advancement
                            }
                        }
                    }
                }
            }
            
            return false; // Signal that we haven't handled the question advancement
        }
        
        // Enhanced booking analysis for context-aware questions
        function analyzeBookingDetails(bookingResponse) {
            // Handle both old text format and new multi-select format
            let bookingItems = [];
            
            if (Array.isArray(bookingResponse)) {
                bookingItems = bookingResponse;
            } else if (typeof bookingResponse === 'string') {
                bookingItems = bookingResponse.split(',').map(item => item.trim());
            }
            
            // Analyze each booking item
            bookingItems.forEach(item => {
                const lowerItem = item.toLowerCase();
                
                // Check for accommodation bookings
                if (lowerItem.includes('hotel') || lowerItem.includes('accommodation') || 
                    lowerItem === 'hotels/accommodation') {
                    window.hasBookedAccommodation = true;
                }
                
                // Check for transportation bookings (specific types)
                if (lowerItem.includes('rental car') || lowerItem === 'rental car') {
                    window.hasBookedRentalCar = true;
                    window.hasBookedTransportation = true;
                } else if (lowerItem.includes('train') || lowerItem.includes('bus') || 
                          lowerItem === 'train/bus tickets') {
                    window.hasBookedPublicTransport = true;
                    window.hasBookedTransportation = true;
                } else if (lowerItem.includes('flight') || lowerItem === 'flights') {
                    window.hasBookedFlights = true;
                }
                
                // Check for activity bookings
                if (lowerItem.includes('activities') || lowerItem.includes('tour') || 
                    lowerItem === 'activities/tours') {
                    window.hasBookedActivities = true;
                }
            });
        }
        
        // Convert day option text to number - FIXED for new bubble format
        function dayOptionToNumber(dayText) {
            if (dayText === '1 day') return 1;
            if (dayText.includes('2+ weeks')) return 14;
            if (dayText.includes('1+ month')) return 30;
            
            // Handle individual day options (2 days, 3 days, etc.)
            const match = dayText.match(/(\d+)\s+days?/);
            return match ? parseInt(match[1]) : 1;
        }

        // Generate smart day options based on remaining days - FIXED FOR BUBBLES
        function getSmartDayOptions(remainingDays, isLastDestination = false) {
            const options = [];
            
            if (isLastDestination) {
                // For the last destination, they must use all remaining days
                if (remainingDays === 1) {
                    options.push('1 day');
                } else if (remainingDays > 1) {
                    options.push(`${remainingDays} days`);
                }
            } else {
                // FIXED: Create proper bubble options (1-7 days, 2+ weeks, 1+ month)
                const maxSelectableDays = remainingDays - 1; // Leave at least 1 day for remaining destinations
                
                // Add individual day options (1-7 days)
                for (let i = 1; i <= Math.min(7, maxSelectableDays); i++) {
                    options.push(`${i} day${i > 1 ? 's' : ''}`);
                }
                
                // Add 2+ weeks option only if there are enough days (14+ remaining)
                if (remainingDays >= 15) { // Need at least 15 days (14 for 2 weeks + 1 for other destinations)
                    options.push('2+ weeks');
                }
                
                // Add 1+ month option only if there are enough days (30+ remaining)
                if (remainingDays >= 31) { // Need at least 31 days (30 for 1 month + 1 for other destinations)
                    options.push('1+ month');
                }
            }
            
            return options;
        }

        // SMART CONTEXT-AWARE DAY ALLOCATION SYSTEM - FIXED
        function generateSmartDayAllocationQuestions(destinations) {
            const dynamicQuestions = [];
            
            // Calculate total trip days
            const startDate = formData["Start Date"];
            const endDate = formData["End Date"];
            let totalTripDays = 0;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                totalTripDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            }
            
            // Store total days globally for tracking
            window.totalTripDays = totalTripDays;
            window.remainingDays = totalTripDays;
            window.dayAllocations = {};
            
            destinations.forEach((destination, index) => {
                const capitalizedDestination = destination.charAt(0).toUpperCase() + destination.slice(1).toLowerCase();
                
                // FIXED: Include remaining days in initial text
                const questionText = index === 0 
                    ? `How many days would you like to spend in ${capitalizedDestination}? (You have ${totalTripDays} days total for your trip)`
                    : `How many days would you like to spend in ${capitalizedDestination}?`;
                
                dynamicQuestions.push({
                    id: `destinationDays_${index}`,
                    text: questionText,
                    field: `Days in ${capitalizedDestination}`,
                    isSmartDayQuestion: true,
                    destinationIndex: index,
                    destinationName: capitalizedDestination,
                    totalTripDays: totalTripDays,
                    options: [], // Will be populated dynamically based on remaining days
                    validation: 'smartDayValidation'
                });
            });
            
            return dynamicQuestions;
        }
        
        // Validate destination days don't exceed trip length
        function validateDestinationDays() {
            const startDate = formData["Start Date"];
            const endDate = formData["End Date"];
            
            if (!startDate || !endDate) return true; // Skip validation if dates not set
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const totalTripDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            let totalDestinationDays = 0;
            
            // Count all destination days
            Object.keys(formData).forEach(key => {
                if (key.startsWith('Days in ')) {
                    const daysText = formData[key];
                    if (daysText.includes('2+ weeks')) {
                        totalDestinationDays += 14;
                    } else if (daysText.includes('1+ month')) {
                        totalDestinationDays += 30;
                    } else {
                        const dayNumber = parseInt(daysText.match(/\d+/));
                        if (dayNumber) {
                            totalDestinationDays += dayNumber;
                        }
                    }
                }
            });
            
            return totalDestinationDays <= totalTripDays;
        }
        
        // Get context-aware question text
        function getContextAwareText(question) {
            if (question.contextAwareText) {
                // Check for accommodation context
                if (window.hasBookedAccommodation && question.contextAwareText.hasBookedAccommodation) {
                    return question.contextAwareText.hasBookedAccommodation;
                }
                
                // Check for transportation context
                if (window.hasBookedTransportation && question.contextAwareText.hasBookedTransportation) {
                    return question.contextAwareText.hasBookedTransportation;
                }
            }
            
            return question.text;
        }
        
        // Helper function to check if we should skip a question
        function shouldSkipQuestion(question) {
            // Skip "Other" details question if "Other" wasn't selected
            if (question.id === 'bookedOtherDetails' && window.skipOtherDetails) {
                return true;
            }
            
            // Skip destination specificity question for single destinations
            if (question.id === 'destinationSpecificity' && !window.isMultiDestination) {
                return true;
            }
            
            // Skip multi-destination setup for single destinations
            if (question.id === 'destinationDaysAllocation' && !window.isMultiDestination) {
                return true;
            }
            
            if (question.skipIf) {
                switch (question.skipIf) {
                    case 'hasBookedHotel':
                        return window.hasBookedHotel === true;
                    case 'hasBookedTransportation':
                        return window.hasBookedTransportation === true;
                    case 'hasBookedActivities':
                        return window.hasBookedActivities === true;
                    default:
                        return false;
                }
            }
            return false;
        }
        
        // Helper function to check if we're currently correcting fields
        function isCorrectingField() {
            return window.isInCorrectionMode === true && fieldsToCorrect && fieldsToCorrect.length > 0;
        }
        
        // Get simplified correction prompts for each field
        function getCorrectionPrompt(fieldName, language) {
            const isEnglish = language === 'en';
            
            // Safety check to prevent undefined fields
            if (!fieldName) {
                return isEnglish ? 
                    "Please correct this information:" : 
                    "Por favor, corrija esta informaciÃ³n:";
            }
            
            // English correction prompts
            const englishPrompts = {
                'Full Name': "Please correct your full name below:",
                'Email': "Please provide the correct email address:",
                'Origin': "Please correct where you'll be traveling from:",
                'Destinations': "Please correct your travel destinations:",
                'Start Date': "Please select the correct departure date:",
                'End Date': "Please select the correct return date:",
                'Number of Travelers': "Please correct the number of travelers:",
                'Ages of Travelers': "Please correct the ages of travelers:",
                'Total Budget ($)': "Please correct your total budget:"
            };
            
            // Spanish correction prompts
            const spanishPrompts = {
                'Nombre Completo': "Por favor, corrija su nombre completo a continuaciÃ³n:",
                'Correo ElectrÃ³nico': "Por favor, proporcione la direcciÃ³n de correo electrÃ³nico correcta:",
                'Origen': "Por favor, corrija desde dÃ³nde viajarÃ¡:",
                'Destinos': "Por favor, corrija sus destinos de viaje:",
                'Fecha de Inicio': "Por favor, seleccione la fecha de salida correcta:",
                'Fecha de Regreso': "Por favor, seleccione la fecha de regreso correcta:",
                'NÃºmero de Viajeros': "Por favor, corrija el nÃºmero de viajeros:",
                'Edades de los Viajeros': "Por favor, corrija las edades de los viajeros:",
                'Presupuesto Total ($)': "Por favor, corrija su presupuesto total:"
            };
            
            return isEnglish ? 
                (englishPrompts[fieldName] || `Please correct your ${fieldName}:`) : 
                (spanishPrompts[fieldName] || `Por favor, corrija su ${fieldName}:`);
        }
        
        // Create submit button for final question
        function createSubmitButton() {
            console.log('ðŸŽ¯ CREATING SUBMIT BUTTON - START');
            const chatContainer = document.querySelector('.chat-container');
            const inputContainer = document.querySelector('.chat-input-container');
            
            console.log('ðŸŽ¯ Chat container found:', !!chatContainer);
            console.log('ðŸŽ¯ Input container found:', !!inputContainer);
            
            if (!chatContainer || !inputContainer) {
                console.error('âŒ Required containers not found!');
                return;
            }
            
            // Remove any existing submit container
            const existingSubmit = document.querySelector('.submit-container');
            if (existingSubmit) {
                existingSubmit.remove();
            }
            
            // Create submit button container
            const submitContainer = document.createElement('div');
            submitContainer.className = 'submit-container';
            submitContainer.style.cssText = `
                padding: 20px;
                text-align: center;
                background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(217, 119, 6, 0.05));
                border-top: 1px solid rgba(79, 70, 229, 0.2);
            `;
            
            // Create submit button
            const submitButton = document.createElement('button');
            submitButton.className = 'submit-itinerary-btn';
            submitButton.innerHTML = questions === questionsEN ? 
                'ðŸš€ Create My Travel Itinerary' : 
                'ðŸš€ Crear Mi Itinerario de Viaje';
            
            submitButton.style.cssText = `
                background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
                color: white;
                border: none;
                padding: 16px 32px;
                border-radius: 25px;
                font-size: 1.1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
                min-width: 280px;
                position: relative;
                overflow: hidden;
            `;
            
            // Add hover effects
            submitButton.addEventListener('mouseenter', () => {
                submitButton.style.transform = 'translateY(-2px)';
                submitButton.style.boxShadow = '0 6px 20px rgba(79, 70, 229, 0.4)';
            });
            
            submitButton.addEventListener('mouseleave', () => {
                submitButton.style.transform = 'translateY(0)';
                submitButton.style.boxShadow = '0 4px 15px rgba(79, 70, 229, 0.3)';
            });
            
            // Add click handler
            submitButton.addEventListener('click', () => {
                console.log('ðŸš€ SUBMIT BUTTON CLICKED!');
                submitButton.disabled = true;
                submitButton.innerHTML = questions === questionsEN ? 
                    'â³ Creating Your Itinerary...' : 
                    'â³ Creando Tu Itinerario...';
                submitButton.style.background = 'linear-gradient(135deg, #6b7280, #9ca3af)';
                
                // Submit the form data
                submitFormData().then(() => {
                    submitButton.innerHTML = questions === questionsEN ? 
                        'âœ… Itinerary Request Sent!' : 
                        'âœ… Â¡Solicitud de Itinerario Enviada!';
                    submitButton.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                }).catch((error) => {
                    console.error('âŒ Submit error:', error);
                    submitButton.innerHTML = questions === questionsEN ? 
                        'âŒ Error - Please Try Again' : 
                        'âŒ Error - IntÃ©ntalo de Nuevo';
                    submitButton.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    submitButton.disabled = false;
                });
            });
            
            submitContainer.appendChild(submitButton);
            
            // Insert before input container
            chatContainer.insertBefore(submitContainer, inputContainer);
            
            console.log('âœ… SUBMIT BUTTON CREATED AND ADDED TO DOM');
        }

        // Global handler for direct submit button
        window.handleDirectSubmit = function(button) {
            console.log('ðŸš€ DIRECT SUBMIT BUTTON CLICKED!');
            button.disabled = true;
            button.innerHTML = questions === questionsEN ? 'â³ Creating Your Itinerary...' : 'â³ Creando Tu Itinerario...';
            button.style.background = 'linear-gradient(135deg, #6b7280, #9ca3af)';
            
            submitFormData().then(() => {
                button.innerHTML = questions === questionsEN ? 'âœ… Itinerary Request Sent!' : 'âœ… Â¡Solicitud de Itinerario Enviada!';
                button.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            }).catch((error) => {
                console.error('âŒ Direct submit error:', error);
                button.innerHTML = questions === questionsEN ? 'âŒ Error - Please Try Again' : 'âŒ Error - IntÃ©ntalo de Nuevo';
                button.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                button.disabled = false;
            });
        };

        // Submit all collected data to webhook - UPDATED to return Promise
        function submitFormData() {
            console.log('ðŸš€ SUBMITTING FORM DATA TO WEBHOOK');
            console.log('ðŸ“ Webhook URL:', webhookUrl);
            console.log('ðŸ“Š Form Data:', formData);
            console.log('ðŸ’¬ Message History:', messageHistory);
            
            return fetch(webhookUrl, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    conversationId: conversationId,
                    formData: formData,
                    messageHistory: messageHistory,
                    triggerFollowUp: true,
                    language: questions === questionsEN ? 'en' : 'es'
                })
            })
            .then(response => {
                console.log('ðŸ“¡ Webhook Response Status:', response.status);
                console.log('ðŸ“¡ Webhook Response OK:', response.ok);
                if (response.ok) {
                    return response.json().catch(() => ({ response: null }));
                } else {
                    console.error('âŒ Webhook failed with status:', response.status);
                    throw new Error(`Webhook failed with status: ${response.status}`);
                }
            })
            .then(data => {
                console.log('âœ… Travel itinerary request submitted successfully');
                console.log('ðŸ“‹ Response data:', data);
                return data;
            })
            .catch(error => {
                console.error('âŒ Error submitting travel data:', error);
                console.error('âŒ Error details:', error.message);
                throw error;
            });
        }
        
        // Add agent message to chat
        function addAgentMessage(text, options, multiselect, isError = false) {
            console.log('ðŸ“ Adding agent message:', text.substring(0, 100) + '...');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent-message';
            
            const messageContent = document.createElement('div');
            if (isError) {
                messageContent.className = 'message-content error-message';
            } else {
                messageContent.className = 'message-content';
            }
            messageContent.textContent = text;
            messageDiv.appendChild(messageContent);
            
            // Get current question
            const currentQ = questions[currentQuestion];
            

            
            // Handle calendar picker for travel dates
            if (currentQ && currentQ.isCalendarPicker) {
                const calendarPicker = document.createElement('div');
                calendarPicker.className = 'calendar-picker';
                calendarPicker.dataset.questionId = currentQ.id; // Add question ID for tracking
                
                // Create month/year selector
                const monthYearSelector = document.createElement('div');
                monthYearSelector.className = 'month-year-selector';
                monthYearSelector.style.display = 'flex';
                monthYearSelector.style.justifyContent = 'space-between';
                monthYearSelector.style.alignItems = 'center';
                monthYearSelector.style.marginBottom = '15px';
                monthYearSelector.style.padding = '10px';
                monthYearSelector.style.backgroundColor = 'rgba(79, 70, 229, 0.1)';
                monthYearSelector.style.borderRadius = '8px';
                
                const prevButton = document.createElement('button');
                prevButton.textContent = 'â—€';
                prevButton.style.background = 'none';
                prevButton.style.border = 'none';
                prevButton.style.fontSize = '18px';
                prevButton.style.cursor = 'pointer';
                prevButton.style.color = 'var(--primary-color)';
                
                const monthYearDisplay = document.createElement('div');
                monthYearDisplay.style.fontSize = '16px';
                monthYearDisplay.style.fontWeight = '600';
                monthYearDisplay.style.color = 'var(--primary-color)';
                
                const nextButton = document.createElement('button');
                nextButton.textContent = 'â–¶';
                nextButton.style.background = 'none';
                nextButton.style.border = 'none';
                nextButton.style.fontSize = '18px';
                nextButton.style.cursor = 'pointer';
                nextButton.style.color = 'var(--primary-color)';
                
                monthYearSelector.appendChild(prevButton);
                monthYearSelector.appendChild(monthYearDisplay);
                monthYearSelector.appendChild(nextButton);
                
                // Create calendar grid container
                const calendarGrid = document.createElement('div');
                calendarGrid.style.display = 'grid';
                calendarGrid.style.gridTemplateColumns = 'repeat(7, 1fr)';
                calendarGrid.style.gap = '5px';
                calendarGrid.style.border = '1px solid rgba(217, 119, 6, 0.2)';
                calendarGrid.style.padding = '10px';
                calendarGrid.style.borderRadius = '8px';
                calendarGrid.style.backgroundColor = 'rgba(255, 255, 255, 0.6)';
                
                // Current date tracking
                let currentDate = new Date();
                let displayMonth = currentDate.getMonth();
                let displayYear = currentDate.getFullYear();
                
                function renderCalendar() {
                    // Clear previous calendar
                    calendarGrid.innerHTML = '';
                    
                    // Update month/year display
                    const monthNames = questions === questionsEN ?
                        ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] :
                        ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    
                    monthYearDisplay.textContent = `${monthNames[displayMonth]} ${displayYear}`;
                    
                    // Create day headers
                    const dayNames = questions === questionsEN ? 
                        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'] : 
                        ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'];
                    
                    dayNames.forEach(day => {
                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'day-header';
                        dayHeader.textContent = day;
                        dayHeader.style.textAlign = 'center';
                        dayHeader.style.fontSize = '0.7rem';
                        dayHeader.style.fontWeight = '600';
                        dayHeader.style.color = 'var(--text-light)';
                        dayHeader.style.marginBottom = '5px';
                        calendarGrid.appendChild(dayHeader);
                    });
                    
                    // Get first day of month and number of days
                    const firstDay = new Date(displayYear, displayMonth, 1);
                    const lastDay = new Date(displayYear, displayMonth + 1, 0);
                    const firstDayOfWeek = firstDay.getDay();
                    const daysInMonth = lastDay.getDate();
                    
                    // Add empty cells for days before month starts
                    for (let i = 0; i < firstDayOfWeek; i++) {
                        const emptyCell = document.createElement('div');
                        calendarGrid.appendChild(emptyCell);
                    }
                    
                    // Add days of the month
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayOption = document.createElement('div');
                        dayOption.className = 'day-option';
                        dayOption.textContent = day;
                        dayOption.style.padding = '10px 5px';
                        dayOption.style.border = '1px solid var(--primary-light)';
                        dayOption.style.borderRadius = '8px';
                        dayOption.style.textAlign = 'center';
                        dayOption.style.cursor = 'pointer';
                        dayOption.style.transition = 'all 0.2s ease';
                        dayOption.style.backgroundColor = 'var(--white)';
                        dayOption.style.color = 'var(--primary-color)';
                        dayOption.style.fontSize = '0.8rem';
                        dayOption.style.minHeight = '40px';
                        dayOption.style.display = 'flex';
                        dayOption.style.alignItems = 'center';
                        dayOption.style.justifyContent = 'center';
                        
                        // Check if this date is in the past (disable if so)
                        const thisDate = new Date(displayYear, displayMonth, day);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        if (thisDate < today) {
                            dayOption.style.opacity = '0.3';
                            dayOption.style.cursor = 'not-allowed';
                            dayOption.style.backgroundColor = '#f5f5f5';
                        } else {
                            const formattedDate = `${monthNames[displayMonth]} ${day}, ${displayYear}`;
                            dayOption.dataset.fullDate = formattedDate;
                            
                            dayOption.addEventListener('click', () => {
                                // Remove selected class from all options
                                document.querySelectorAll('.day-option').forEach(opt => {
                                    opt.classList.remove('selected');
                                });
                                
                                // Add selected class to clicked option
                                dayOption.classList.add('selected');
                                dayOption.style.backgroundColor = 'var(--primary-color)';
                                dayOption.style.color = 'var(--white)';
                                dayOption.style.fontWeight = '500';
                                dayOption.style.borderColor = 'var(--primary-dark)';
                                
                                // Set the input value to the full date
                                chatInput.value = formattedDate;
                                
                                // Focus the input after selecting a date
                                chatInput.focus();
                            });
                            
                            dayOption.addEventListener('mouseenter', () => {
                                if (!dayOption.classList.contains('selected')) {
                                    dayOption.style.backgroundColor = 'var(--primary-light)';
                                    dayOption.style.color = 'var(--white)';
                                }
                            });
                            
                            dayOption.addEventListener('mouseleave', () => {
                                if (!dayOption.classList.contains('selected')) {
                                    dayOption.style.backgroundColor = 'var(--white)';
                                    dayOption.style.color = 'var(--primary-color)';
                                }
                            });
                        }
                        
                        calendarGrid.appendChild(dayOption);
                    }
                }
                
                // Navigation event listeners
                prevButton.addEventListener('click', () => {
                    displayMonth--;
                    if (displayMonth < 0) {
                        displayMonth = 11;
                        displayYear--;
                    }
                    // Don't allow going to past months
                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();
                    if (displayYear < currentYear || (displayYear === currentYear && displayMonth < currentMonth)) {
                        displayMonth = currentMonth;
                        displayYear = currentYear;
                    }
                    renderCalendar();
                });
                
                nextButton.addEventListener('click', () => {
                    displayMonth++;
                    if (displayMonth > 11) {
                        displayMonth = 0;
                        displayYear++;
                    }
                    // Limit to 2 years in the future
                    const maxYear = new Date().getFullYear() + 2;
                    if (displayYear > maxYear) {
                        displayYear = maxYear;
                        displayMonth = 11;
                    }
                    renderCalendar();
                });
                
                // Initial render
                renderCalendar();
                
                calendarPicker.appendChild(monthYearSelector);
                calendarPicker.appendChild(calendarGrid);
                messageDiv.appendChild(calendarPicker);
            }
            
            // Add options if provided (for multiple choice questions) - FIXED for smart day questions
            if ((options && options.length && !currentQ.isCalendarPicker) || (currentQ && currentQ.isSmartDayQuestion)) {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';
                optionsContainer.dataset.questionId = currentQ.id;
                
                // Handle smart day allocation questions with enhanced bubble interface
                let finalOptions = options;
                if (currentQ && currentQ.isSmartDayQuestion) {
                    const remainingDestinations = window.destinationList ? window.destinationList.length - currentQ.destinationIndex - 1 : 0;
                    const isLastDestination = remainingDestinations === 0;
                    finalOptions = getSmartDayOptions(window.remainingDays || 1, isLastDestination);
                    
                    // Add enhanced context card showing remaining days
                    const contextDiv = document.createElement('div');
                    contextDiv.className = 'day-context-card';
                    contextDiv.style.cssText = `
                        background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(217, 119, 6, 0.1));
                        padding: 16px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        border-left: 4px solid var(--primary-color);
                        font-size: 0.9rem;
                        color: var(--text-dark);
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    `;
                    
                    if (isLastDestination) {
                        contextDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 1.2rem;">ðŸ</span>
                                <strong style="color: var(--primary-color);">Final Destination</strong>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">
                                You have <strong style="color: var(--accent-color);">${window.remainingDays} day${window.remainingDays > 1 ? 's' : ''}</strong> remaining for <strong>${currentQ.destinationName}</strong>.
                            </div>
                        `;
                    } else {
                        contextDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 1.2rem;">ðŸ“Š</span>
                                <strong style="color: var(--primary-color);">Trip Planning Progress</strong>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 0.8rem;">
                                <div style="text-align: center; padding: 6px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                                    <div style="font-weight: 600; color: var(--primary-color);">${window.totalTripDays}</div>
                                    <div style="color: var(--text-light);">Total Days</div>
                                </div>
                                <div style="text-align: center; padding: 6px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                                    <div style="font-weight: 600; color: var(--accent-color);">${window.remainingDays}</div>
                                    <div style="color: var(--text-light);">Remaining</div>
                                </div>
                                <div style="text-align: center; padding: 6px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                                    <div style="font-weight: 600; color: var(--secondary-color);">${remainingDestinations + 1}</div>
                                    <div style="color: var(--text-light);">Destinations Left</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    messageDiv.appendChild(contextDiv);
                }
                
                finalOptions.forEach(option => {
                    const optionButton = document.createElement('button');
                    optionButton.className = 'option-button';
                    optionButton.textContent = option;
                    optionButton.addEventListener('click', () => {
                        if (multiselect) {
                            // For multiselect, collect options in input field
                            if (chatInput.value) {
                                if (!chatInput.value.includes(option)) {
                                    chatInput.value += ', ' + option;
                                }
                            } else {
                                chatInput.value = option;
                            }
                            chatInput.focus();
                        } else {
                            // For single select, immediately submit the option
                            chatInput.value = option;
                            sendMessage();
                        }
                    });
                    optionsContainer.appendChild(optionButton);
                });
                
                // Don't append options container yet for confirmation questions
                if (!currentQ || !currentQ.isConfirmation) {
                    messageDiv.appendChild(optionsContainer);
                }
            }
            
            // Handle day allocation confirmation - SINGLE OCCURRENCE ONLY
            if (currentQ && currentQ.isDayAllocationConfirmation) {
                const dayAllocationSummary = document.createElement('div');
                dayAllocationSummary.className = 'day-allocation-summary';
                dayAllocationSummary.style.cssText = `
                    background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(217, 119, 6, 0.1));
                    padding: 20px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                    border-left: 4px solid var(--primary-color);
                `;
                
                const summaryTitle = document.createElement('div');
                summaryTitle.style.cssText = `
                    font-size: 1.1rem;
                    font-weight: 600;
                    color: var(--primary-color);
                    margin-bottom: 15px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                `;
                summaryTitle.innerHTML = `ðŸ“Š Your Day Allocation Summary`;
                dayAllocationSummary.appendChild(summaryTitle);
                
                // Display each destination allocation
                if (window.dayAllocations) {
                    Object.entries(window.dayAllocations).forEach(([destination, days]) => {
                        const allocationItem = document.createElement('div');
                        allocationItem.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 10px 0;
                            border-bottom: 1px solid rgba(79, 70, 229, 0.2);
                        `;
                        
                        const destinationName = document.createElement('span');
                        destinationName.style.cssText = `
                            font-weight: 500;
                            color: var(--text-dark);
                        `;
                        destinationName.textContent = destination;
                        
                        const dayCount = document.createElement('span');
                        dayCount.style.cssText = `
                            background: var(--primary-color);
                            color: white;
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 0.9rem;
                            font-weight: 500;
                        `;
                        dayCount.textContent = `${days} day${days > 1 ? 's' : ''}`;
                        
                        allocationItem.appendChild(destinationName);
                        allocationItem.appendChild(dayCount);
                        dayAllocationSummary.appendChild(allocationItem);
                    });
                }
                
                // Total summary
                const totalSummary = document.createElement('div');
                totalSummary.style.cssText = `
                    margin-top: 15px;
                    padding-top: 15px;
                    border-top: 2px solid var(--primary-color);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-weight: 600;
                `;
                
                const totalLabel = document.createElement('span');
                totalLabel.textContent = 'Total Trip Duration:';
                totalLabel.style.color = 'var(--text-dark)';
                
                const totalDays = document.createElement('span');
                totalDays.style.cssText = `
                    background: var(--accent-color);
                    color: white;
                    padding: 6px 16px;
                    border-radius: 25px;
                    font-size: 1rem;
                `;
                totalDays.textContent = `${window.totalTripDays} days`;
                
                totalSummary.appendChild(totalLabel);
                totalSummary.appendChild(totalDays);
                dayAllocationSummary.appendChild(totalSummary);
                
                messageDiv.appendChild(dayAllocationSummary);
                
                // Add options for confirmation
                if (options && options.length > 0) {
                    const optionsContainer = document.createElement('div');
                    optionsContainer.className = 'options-container';
                    optionsContainer.dataset.questionId = currentQ.id;
                    
                    options.forEach(option => {
                        const optionButton = document.createElement('button');
                        optionButton.className = 'option-button';
                        optionButton.textContent = option;
                        optionButton.addEventListener('click', () => {
                            chatInput.value = option;
                            sendMessage();
                        });
                        optionsContainer.appendChild(optionButton);
                    });
                    
                    messageDiv.appendChild(optionsContainer);
                }
            }
            
            // Handle confirmation summary
            if (currentQ && currentQ.isConfirmation) {
                const confirmationSummary = document.createElement('div');
                confirmationSummary.className = 'confirmation-summary';
                
                // Add each item in a structured format based on language
                const confirmationFields = questions === questionsEN ? 
                    [
                        { label: 'Name', field: 'Full Name' },
                        { label: 'Email', field: 'Email' },
                        { label: 'Origin', field: 'Origin' },
                        { label: 'Destinations', field: 'Destinations' },
                        { label: 'Start Date', field: 'Start Date' },
                        { label: 'End Date', field: 'End Date' },
                        { label: 'Travelers', field: 'Number of Travelers' },
                        { label: 'Ages', field: 'Ages of Travelers' },
                        { label: 'Budget', field: 'Total Budget ($)' },
                        { label: 'Booked in Advance', field: 'Booked in Advance' },
                        { label: 'Booking Details', field: 'Booking Details' },
                        { label: 'Accommodation', field: 'Preferred Accommodation' },
                        { label: 'Transportation', field: 'Preferred Transportation' },
                        { label: 'Trip Style', field: 'Trip Style (select all that apply)' },
                        { label: 'Activity Level', field: 'Activity Level' },
                        { label: 'Must-See Places', field: 'Must-See Places' },
                        { label: 'Must-Do Activities', field: 'Must-Do Activities' },
                        { label: 'Dietary Restrictions', field: 'Dietary Restrictions' },
                        { label: 'Special Interests', field: 'Special Interests' },
                        { label: 'Free Time', field: 'Free Time Preference' }
                    ] : 
                    [
                        { label: 'Nombre', field: 'Nombre Completo' },
                        { label: 'Correo', field: 'Correo ElectrÃ³nico' },
                        { label: 'Origen', field: 'Origen' },
                        { label: 'Destinos', field: 'Destinos' },
                        { label: 'Fecha de Inicio', field: 'Fecha de Inicio' },
                        { label: 'Fecha de Regreso', field: 'Fecha de Regreso' },
                        { label: 'Viajeros', field: 'NÃºmero de Viajeros' },
                        { label: 'Edades', field: 'Edades de los Viajeros' },
                        { label: 'Presupuesto', field: 'Presupuesto Total ($)' },
                        { label: 'Reservado por Adelantado', field: 'Reservado por Adelantado' },
                        { label: 'Detalles de Reservas', field: 'Detalles de Reservas' },
                        { label: 'Alojamiento', field: 'Alojamiento Preferido' },
                        { label: 'Transporte', field: 'Transporte Preferido' },
                        { label: 'Estilo de Viaje', field: 'Estilo de Viaje (selecciona todo lo que aplique)' },
                        { label: 'Nivel de Actividad', field: 'Nivel de Actividad' },
                        { label: 'Lugares Imperdibles', field: 'Lugares Imperdibles' },
                        { label: 'Actividades Imperdibles', field: 'Actividades Imperdibles' },
                        { label: 'Restricciones DietÃ©ticas', field: 'Restricciones DietÃ©ticas' },
                        { label: 'Intereses Especiales', field: 'Intereses Especiales' },
                        { label: 'Tiempo Libre', field: 'Preferencia de Tiempo Libre' }
                    ];
                
                confirmationFields.forEach(item => {
                    if (formData[item.field]) {
                        const confirmationItem = document.createElement('div');
                        confirmationItem.className = 'confirmation-item';
                        
                        const label = document.createElement('div');
                        label.className = 'confirmation-label';
                        label.textContent = item.label + ':';
                        
                        const value = document.createElement('div');
                        value.className = 'confirmation-value';
                        value.textContent = formData[item.field];
                        
                        confirmationItem.appendChild(label);
                        confirmationItem.appendChild(value);
                        confirmationSummary.appendChild(confirmationItem);
                    }
                });
                
                messageDiv.appendChild(confirmationSummary);
                
                // Add options AFTER confirmation summary for better mobile UX
                if (options && options.length > 0) {
                    const optionsContainer = document.createElement('div');
                    optionsContainer.className = 'options-container';
                    optionsContainer.dataset.questionId = currentQ.id;
                    
                    options.forEach(option => {
                        const optionButton = document.createElement('button');
                        optionButton.className = 'option-button';
                        optionButton.textContent = option;
                        optionButton.addEventListener('click', () => {
                            if (multiselect) {
                                // For multiselect, collect options in input field
                                if (chatInput.value) {
                                    if (!chatInput.value.includes(option)) {
                                        chatInput.value += ', ' + option;
                                    }
                                } else {
                                    chatInput.value = option;
                                }
                                chatInput.focus();
                            } else {
                                // For single select, immediately submit the option
                                chatInput.value = option;
                                sendMessage();
                            }
                        });
                        optionsContainer.appendChild(optionButton);
                    });
                    
                    messageDiv.appendChild(optionsContainer);
                }
            }
            
            chatBody.appendChild(messageDiv);
            scrollToBottom();
            
            // SPECIAL HANDLING: Add submit button after final message
            console.log('ðŸ” Checking if this is final message:', text.substring(0, 100));
            if (text.includes("I'm creating your personalized travel itinerary") || 
                text.includes("Estoy creando tu itinerario") ||
                text.includes("creating your personalized travel itinerary") ||
                text.includes("creando tu itinerario de viaje personalizado")) {
                console.log('âœ… FINAL MESSAGE DETECTED - Adding submit button');
                setTimeout(() => {
                    // Hide input and send button
                    const chatInput = document.getElementById('chatInput') || document.getElementById('chatInputES');
                    const sendButton = document.getElementById('sendButton') || document.getElementById('sendButtonES');
                    if (chatInput) chatInput.style.display = 'none';
                    if (sendButton) sendButton.style.display = 'none';
                    
                    // Add submit button directly to chat
                    const submitDiv = document.createElement('div');
                    submitDiv.className = 'submit-button-container';
                    submitDiv.style.cssText = 'text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(217, 119, 6, 0.05)); border-radius: 10px; margin: 20px 0; border-top: 1px solid rgba(79, 70, 229, 0.2);';
                    
                    const submitBtn = document.createElement('button');
                    submitBtn.innerHTML = questions === questionsEN ? 'ðŸš€ Create My Travel Itinerary' : 'ðŸš€ Crear Mi Itinerario de Viaje';
                    submitBtn.style.cssText = 'background: linear-gradient(135deg, #4f46e5, #d97706); color: white; border: none; padding: 16px 32px; border-radius: 25px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); min-width: 280px; transition: all 0.3s ease;';
                    
                    submitBtn.onclick = () => {
                        console.log('ðŸš€ SUBMIT BUTTON CLICKED!');
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = questions === questionsEN ? 'â³ Creating Your Itinerary...' : 'â³ Creando Tu Itinerario...';
                        submitBtn.style.background = 'linear-gradient(135deg, #6b7280, #9ca3af)';
                        
                        submitFormData().then(() => {
                            submitBtn.innerHTML = questions === questionsEN ? 'âœ… Itinerary Request Sent!' : 'âœ… Â¡Solicitud de Itinerario Enviada!';
                            submitBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                        }).catch((error) => {
                            console.error('âŒ Submit error:', error);
                            submitBtn.innerHTML = questions === questionsEN ? 'âŒ Error - Please Try Again' : 'âŒ Error - IntÃ©ntalo de Nuevo';
                            submitBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                            submitBtn.disabled = false;
                        });
                    };
                    
                    submitDiv.appendChild(submitBtn);
                    chatBody.appendChild(submitDiv);
                    scrollToBottom();
                    
                    console.log('âœ… SUBMIT BUTTON ADDED AFTER FINAL MESSAGE');
                }, 1000);
            }
            
            // Auto-focus the input field after showing a new message
            if (!options || options.length === 0) {
                chatInput.focus();
            }
            
            // Immediately disable options from previous questions to prevent interaction
            disablePreviousOptions();
            
            // Also call with a small delay to ensure DOM is fully updated
            setTimeout(() => {
                disablePreviousOptions();
            }, 50);
        }
        
        // Add user message to chat
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = text;
            messageDiv.appendChild(messageContent);
            
            chatBody.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            typingIndicator.style.display = 'flex';
            scrollToBottom();
        }
        
        // Hide typing indicator
        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }
        
        // Scroll chat to bottom
        function scrollToBottom() {
            chatBody.scrollTop = chatBody.scrollHeight;
        }
        
        // Function to disable all option buttons for previous questions
        function disablePreviousOptions() {
            // Get all option buttons in the chat
            const allOptionButtons = document.querySelectorAll('.option-button');
            
            allOptionButtons.forEach(button => {
                // Find the parent options container
                const container = button.closest('.options-container');
                if (container && container.dataset.questionId) {
                    const questionId = container.dataset.questionId;
                    const questionIndex = questions.findIndex(q => q.id === questionId);
                    
                    // If this is a previous question, disable its option buttons
                    if (questionIndex < currentQuestion && questionIndex !== -1) {
                        button.disabled = true;
                        button.classList.add('disabled');
                        button.style.opacity = '0.5';
                        button.style.cursor = 'not-allowed';
                        button.style.pointerEvents = 'none';
                        button.style.backgroundColor = '#f5f5f5';
                        button.style.color = '#999';
                        
                        // Remove all event listeners by cloning and replacing
                        const newButton = button.cloneNode(true);
                        button.parentNode.replaceChild(newButton, button);
                    }
                }
            });
            
            // Also disable calendar pickers for previous questions
            const calendarPickers = document.querySelectorAll('.calendar-picker');
            calendarPickers.forEach(picker => {
                if (picker.dataset.questionId) {
                    const questionId = picker.dataset.questionId;
                    const questionIndex = questions.findIndex(q => q.id === questionId);
                    
                    // If this is a previous question, disable its calendar
                    if (questionIndex < currentQuestion && questionIndex !== -1) {
                        const dayOptions = picker.querySelectorAll('.day-option');
                        const navButtons = picker.querySelectorAll('button');
                        
                        // Disable all day options
                        dayOptions.forEach(day => {
                            day.style.opacity = '0.5';
                            day.style.cursor = 'not-allowed';
                            day.style.pointerEvents = 'none';
                            day.style.backgroundColor = '#f5f5f5';
                            
                            // Remove event listeners by cloning and replacing
                            const newDay = day.cloneNode(true);
                            day.parentNode.replaceChild(newDay, day);
                        });
                        
                        // Disable navigation buttons
                        navButtons.forEach(button => {
                            button.disabled = true;
                            button.style.opacity = '0.5';
                            button.style.cursor = 'not-allowed';
                            button.style.pointerEvents = 'none';
                        });
                    }
                }
            });
        }

        // Simple submit button function - GUARANTEED TO WORK
        function addSimpleSubmitButton() {
            console.log('ðŸŽ¯ ADDING SIMPLE SUBMIT BUTTON');
            
            // Remove any existing submit buttons
            const existingSubmits = document.querySelectorAll('.submit-button-container, .submit-container');
            existingSubmits.forEach(btn => btn.remove());
            
            const chatBody = document.getElementById('chatBody') || document.getElementById('chatBodyES');
            if (!chatBody) {
                console.error('âŒ Chat body not found');
                return;
            }
            
            const submitDiv = document.createElement('div');
            submitDiv.className = 'submit-button-container simple-submit';
            submitDiv.style.cssText = `
                text-align: center; 
                padding: 20px; 
                background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(217, 119, 6, 0.05)); 
                border-radius: 10px; 
                margin: 20px 0; 
                border-top: 1px solid rgba(79, 70, 229, 0.2);
                border: 2px solid #4f46e5;
            `;
            
            const submitBtn = document.createElement('button');
            submitBtn.innerHTML = questions === questionsEN ? 'ðŸš€ Create My Travel Itinerary' : 'ðŸš€ Crear Mi Itinerario de Viaje';
            submitBtn.style.cssText = `
                background: linear-gradient(135deg, #4f46e5, #d97706); 
                color: white; 
                border: none; 
                padding: 16px 32px; 
                border-radius: 25px; 
                font-size: 1.1rem; 
                font-weight: 600; 
                cursor: pointer; 
                box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); 
                min-width: 280px; 
                transition: all 0.3s ease;
            `;
            
            submitBtn.onclick = () => {
                console.log('ðŸš€ SIMPLE SUBMIT BUTTON CLICKED!');
                submitBtn.disabled = true;
                submitBtn.innerHTML = questions === questionsEN ? 'â³ Creating Your Itinerary...' : 'â³ Creando Tu Itinerario...';
                submitBtn.style.background = 'linear-gradient(135deg, #6b7280, #9ca3af)';
                
                submitFormData().then(() => {
                    submitBtn.innerHTML = questions === questionsEN ? 'âœ… Itinerary Request Sent!' : 'âœ… Â¡Solicitud de Itinerario Enviada!';
                    submitBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                }).catch((error) => {
                    console.error('âŒ Simple submit error:', error);
                    submitBtn.innerHTML = questions === questionsEN ? 'âŒ Error - Please Try Again' : 'âŒ Error - IntÃ©ntalo de Nuevo';
                    submitBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    submitBtn.disabled = false;
                });
            };
            
            submitDiv.appendChild(submitBtn);
            chatBody.appendChild(submitDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            console.log('âœ… SIMPLE SUBMIT BUTTON ADDED SUCCESSFULLY');
        }

        // Initialize chat when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeChat();
            
            // TEST SUBMIT BUTTON - Add immediately on page load to test
            setTimeout(() => {
                console.log('ðŸ§ª ADDING TEST SUBMIT BUTTON ON PAGE LOAD');
                const chatBody = document.getElementById('chatBody') || document.getElementById('chatBodyES');
                if (chatBody) {
                    const testSubmitDiv = document.createElement('div');
                    testSubmitDiv.className = 'test-submit-container';
                    testSubmitDiv.style.cssText = 'text-align: center; padding: 20px; background: #ffeb3b; border-radius: 10px; margin: 20px 0; border: 2px solid #ff9800;';
                    
                    const testSubmitBtn = document.createElement('button');
                    testSubmitBtn.innerHTML = 'ðŸ§ª TEST SUBMIT BUTTON';
                    testSubmitBtn.style.cssText = 'background: #ff9800; color: white; border: none; padding: 16px 32px; border-radius: 25px; font-size: 1.1rem; font-weight: 600; cursor: pointer; min-width: 280px;';
                    
                    testSubmitBtn.onclick = () => {
                        alert('TEST SUBMIT BUTTON WORKS!');
                        console.log('ðŸ§ª TEST SUBMIT BUTTON CLICKED!');
                    };
                    
                    testSubmitDiv.appendChild(testSubmitBtn);
                    chatBody.appendChild(testSubmitDiv);
                    
                    console.log('âœ… TEST SUBMIT BUTTON ADDED');
                }
            }, 2000);
        });
    </script>
    
    <!-- Mobile fixes script - Ensures proper display on iOS/mobile devices -->
    <script>
        // Fix for iOS 100vh issue
        function setVH() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        // Run when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial height
            setVH();
            
            // Make scrollable areas work properly on iOS
            document.querySelectorAll('.chat-body, .sidebar-content').forEach(el => {
                el.style.webkitOverflowScrolling = 'touch';
            });
        });
        
        // Update on resize and orientation change
        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', function() {
            // Small delay to ensure orientation change is complete
            setTimeout(setVH, 100);
            setTimeout(setVH, 500); // Additional call to handle iOS orientation change delay
        });
    </script>
    
    <!-- Force cleanup script to remove test webhook buttons and fix status dot color -->
    <script>
        // Force cleanup on page load to handle any cached elements
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Remove any test webhook buttons
                const testWebhookBtns = document.querySelectorAll('.test-webhook-btn, #testWebhook, #testWebhookES, [class*="test-webhook"], [id*="testWebhook"]');
                testWebhookBtns.forEach(btn => {
                    console.log('ðŸ§¹ Removing cached test webhook button:', btn);
                    btn.remove();
                });
                
                // Change all status dots to green (universal online color)
                const statusDots = document.querySelectorAll('.status-dot');
                statusDots.forEach(dot => {
                    dot.style.backgroundColor = '#10b981';
                    dot.style.setProperty('background-color', '#10b981', 'important');
                });
                
                console.log('âœ… Page cleanup completed - test buttons removed, status dots changed to green');
            }, 50);
        });
    </script>

</body>
</html> 